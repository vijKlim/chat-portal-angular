(function(a){jQuery.mbEmoticons={author:"Matteo Bicocchi",version:"1.0",smilesPath:"/lib/js/jquery.mb.emoticons/",smiles:{"(angel)":"angel"," :@":"angry","(bandit)":"bandit","(bear)":"bear","(beer)":"beer","(bow)":"bow","(u)":"brokenheart","(bug)":"bug","(^)":"cake","(call)":"call","(cash)":"cash","(clap)":"clapping","(coffee)":"coffee"," 8-)":"cool","(dance)":"dance","(devil)":"devil","(doh)":"doh","(drink)":"drink","(drunk)":"drunk","(dull)":"dull","(blush)":"eblush","(emo)":"emo","(envy)":"envy",
" ]:)":"evilgrin","(F)":"flower","(fubar)":"fubar","(giggle)":"giggle","(handshake)":"handshake","(happy)":"happy","(headbang)":"headbang","(heart)":"heart","(heidy)":"heidy","(hi)":"hi","(inlove)":"inlove","(wasntme)":"itwasntme","(kiss)":"kiss"," :x":"lipssealed","(mail)":"mail","(makeup)":"makeup","(mmm)":"mmm","(mooning)":"mooning","(~)":"movie","(muscle)":"muscle","(music)":"music","(myspace)":"myspace"," 8-|":"nerd","(ninja)":"ninja","(no)":"no","(nod)":"nod","(party)":"party","(phone)":"phone",
"(pizza)":"pizza","(poolparty)":"poolparty","(puke)":"puke","(punch)":"punch","(rain)":"rain","(rock)":"rock"," :(":"sadsmile","(shake)":"shake"," |-)":"sleepy","(smile)":"smile","(smirk)":"smirk","(smoke)":"smoke"," :|":"speechless","(*)":"star","(sun)":"sun"," :O":"surprised","(swear)":"swear","(sweat)":"sweating","(think)":"thinking","(o)":"time","(tmi)":"tmi","(toivo)":"toivo"," :P":"tongueout","(wait)":"wait","(whew)":"whew","(wink)":"wink"," :^)":"wondering"," :S":"worried","(yawn)":"yawn",
"(yes)":"yes"},smilesVariations:{":-)":"smile",":)":"smile"},swapSmilesVariations:{smile:":)",angel:"(angel)",angry:" :@",bandit:"(bandit)",bear:"(bear)",beer:"(beer)",bow:"(bow)",brokenheart:"(u)",bug:"(bug)",cake:"(^)",call:"(call)",cash:"(cash)",clapping:"(clap)",coffee:"(coffee)",dance:"(dance)",devil:"(devil)",doh:"(doh)",drink:"(drink)",drunk:"(drunk)",dull:"(dull)",eblush:"(blush)",emo:"(emo)",envy:"(envy)",evilgrin:" ]:)",flower:"(F)",fubar:"(fubar)",giggle:"(giggle)",handshake:"(handshake)",
happy:"(happy)",headbang:"(headbang)",heart:"(heart)",heidy:"(heidy)",hi:"(hi)",inlove:"(inlove)",itwasntme:"(wasntme)",kiss:"(kiss)",lipssealed:" :x",mail:"(mail)",makeup:"(makeup)",mmm:"(mmm)",mooning:"(mooning)",movie:"(~)",muscle:"(muscle)",music:"(music)",myspace:"(myspace)",nerd:" 8-|",ninja:"(ninja)",no:"(no)",nod:"(nod)",party:"(party)",phone:"(phone)",pizza:"(pizza)",poolparty:"(poolparty)",puke:"(puke)",punch:"(punch)",rain:"(rain)",rock:"(rock)",sadsmile:" :(",shake:"(shake)",sleepy:" |-)",
smirk:"(smirk)",smoke:"(smoke)",speechless:" :|",star:"(*)",sun:"(sun)",surprised:" :O",swear:"(swear)",sweating:"(sweat)",thinking:"(think)",time:"(o)",tmi:"(tmi)",toivo:"(toivo)",tongueout:" :P",wait:"(wait)",whew:"(whew)",wink:"(wink)",wondering:" :^)",worried:" :S",yawn:"(yawn)",yes:"(yes)"},settings:{},smileBoxBtn:"#smileBoxBtn",getRegExp:function(){var b="/";a.each(a.mbEmoticons.smilesVariations,function(a){a=a.replace(/\)/g,"\\)").replace(/\(/g,"\\(").replace(/\|/g,"\\|").replace(/\*/g,"\\*").replace(/\^/g,
"\\^");b+="("+a+")|"});b+="/g";return eval(b)},swapValueOnProp:function(){a.each(a.mbEmoticons.smilesVariations,function(){})},replaceSmileByCode:function(){var b=a(this).html();return b=b.replace(/<img[^"']+?src=(['"]?)(?:[^>]*\/)*([^\/]*?)(?:\.\w+\b)(?!\.\w)\1[^>]*?>/img,function(b,d,c){return a.mbEmoticons.swapSmilesVariations[c]})},replaceImgTagByCode:function(b){return b=b.replace(/<img[^"']+?src=(['"]?)(?:[^>]*\/)*([^\/]*?)(?:\.\w+\b)(?!\.\w)\1[^>]*?>/img,function(b,d,c){return a.mbEmoticons.swapSmilesVariations[c]})},
addSmilesBox:function(b){a.mbEmoticons.settings=a.extend({coveringElement:"",prightBtn:0,ptopBtn:0},b);a(this).each(function(){var b=a(this);a("<span/>").addClass("mbSmilesWrapper");b.data("smilesIsOpen",!0);var d=a("<div/>").addClass("mbSmilesBox").hide(),c=a("<span/>").addClass("mbSmilesButton").html(":-)").emoticonize();0<a.mbEmoticons.settings.prightBtn&&c.css({right:a.mbEmoticons.settings.prightBtn+"px"});0<a.mbEmoticons.settings.ptopBtn&&c.css({top:a.mbEmoticons.settings.ptopBtn+"px"});a.each(a.mbEmoticons.smiles,
function(c){var b=a("<span/>").addClass("emoticon").html(c).attr("title",c);d.append(b);b.emoticonize().data("emoticon",c)});b.before(c);c.click(function(){b.mbOpenSmilesBox()});b.before(d);b.data("smilesBox",d);d.find(".emoticon").each(function(){var c=a(this);a(this).hover(function(){var c=a(this).find("img").attr("src").replace(".png",".gif");a(this).find("img").attr("src",c)},function(){var c=a(this).find("img").attr("src").replace(".gif",".png");a(this).find("img").attr("src",c)}).click(function(){b.insertAtCaret(" "+
c.data("emoticon")+" ")})});console.log(b)});return this},openSmileBox:function(){var b=a(this),e=b.data("smilesBox"),d=a.mbEmoticons.settings.coveringElement?b.closest(a.mbEmoticons.settings.coveringElement):b,c=b.position(),g=d.width(),d=d.height();e.css({width:g,height:d,top:c.top,left:0});e.show();setTimeout(function(){a(document).one("click",function(){b.mbCloseSmilesBox()})},100)},removeSmilesBox:function(){a(this).data("smilesIsOpen",!1);a(this).data("smilesBox").hide()},replaceByImageSrc:function(b,
e){var d=a.mbEmoticons.getRegExp();return b.replace(d,function(c){var b=a.mbEmoticons.smilesVariations[c],f=e?".gif":".png";return b?b=a.mbEmoticons.smilesPath+"smiley/"+b+f:c})},replaceByImage:function(b,e){var d=a.mbEmoticons.getRegExp();return b.replace(d,function(c){var b=a.mbEmoticons.smilesVariations[c],f=e?".gif":".png";return b?b="<img src='"+a.mbEmoticons.smilesPath+"smiley/"+b+f+"' title='"+c+"' align='absmiddle'>":c})}};jQuery.fn.insertAtCaret=function(b){return this.each(function(){this.focus();
var e,d;if(window.getSelection&&(e=window.getSelection(),e.getRangeAt&&e.rangeCount)){d=e.getRangeAt(0);d.deleteContents();e=document.createElement("img");e.src=a.mbEmoticons.replaceByImageSrc(b,!0);e.title=b;d.insertNode(e);var c=document.createTextNode("\u00a0");d.setStartAfter(e);d.insertNode(c);d.setStartAfter(c);d.collapse(!0);e=window.getSelection();e.removeAllRanges();e.addRange(d)}})};jQuery.fn.emoticonize=function(b){function e(d){var c=a.mbEmoticons.getRegExp();return d.replace(c,function(c){var f=
a.mbEmoticons.smilesVariations[c],d=b?".gif":".png";return f?f="<img src='"+a.mbEmoticons.smilesPath+"smiley/"+f+d+"' title='"+c+"' align='absmiddle'>":c})}this.each(function(){var b=a(this),c=e(b.html());b.html(c)});return this};a.extend(a.mbEmoticons.smilesVariations,a.mbEmoticons.smiles);jQuery.fn.mbSmilesBox=a.mbEmoticons.addSmilesBox;jQuery.fn.mbOpenSmilesBox=a.mbEmoticons.openSmileBox;jQuery.fn.mbCloseSmilesBox=a.mbEmoticons.removeSmilesBox;jQuery.fn.replaceSmileByCode=a.mbEmoticons.replaceSmileByCode})(jQuery);var attachMediaModule=angular.module("mediaModule",[]);attachMediaModule.constant("chatConfig",tatetChat);attachMediaModule.factory("CImage",function(){return function(a,b,e){b&&a?(this.image=b,this.id=a,this.type="image",this.container=e):this.container=this.type=this.id=this.image=void 0}});
attachMediaModule.factory("ImagesStorage",["CImage",function(a){return{countItems:0,items:[],isFull:!1,add:function(b,e,d){8>this.items.length?(this.items.push(new a(b,e,d)),this.countItems++,this.isFull=!1):this.isFull=!0},remove:function(a){var e=this;angular.forEach(e.items,function(d,c){d.id==a&&(e.items.splice(c,1),e.countItems--)});8>e.items.length&&(this.isFull=!1)}}}]);
attachMediaModule.factory("MediaAPI",["$http","$sce","$q","chatConfig",function(a,b,e,d){return{mediaContent:null,urlMedia:null,isStart:null,isload:null,isContentSpecificUrl:function(a){var b=a.match(/^https?:\/\/(([^/]*\.)|)tatet\..*(|\/.*)$/img),a=a.match(/^(?:https?:\/\/)?(?:www\.)?(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))((\w|-){11})(?:\S+)?$/img);return b||a?(this.urlMedia=b?b[0]:a[0],this.isStart=!0):!1},getMediaContent:function(c){var b=this;return a.get("/profile/"+
d.myId+"/getMediaContent/",{params:{url:c}}).then(function(a){b.mediaContent=a.data;b.mediaContent.type="media";b.isload=!1},function(){console.log("Error: getMediaContent")})}}}]);attachMediaModule.controller("driveComment",["$scope","MediaAPI","ImagesStorage",function(a,b,e){a.ImagesStorage=e;a.MediaAPI=b}]);
attachMediaModule.directive("isolate",function(){return{restrict:"EA",scope:{eid:"@"},controller:["$scope",function(a){a.active=!1;this.setActive=function(b){a.active=b};this.getActive=function(){return a.active}}],link:function(){}}});attachMediaModule.directive("addGroupImage",["$compile",function(){return{restrict:"AE",link:function(a,b){var e=b.attr("data-id-uploader");b.bind("click",function(){$("#"+e+" input:file").trigger("click")})}}}]);
attachMediaModule.directive("addImageMsg",["$compile",function(){return{restrict:"AE",require:"^isolate",link:function(a,b){var e=b.attr("data-id-uploader");b.bind("click",function(){$(this).parent().find(".e_img_storage").addClass("load_here");$("#"+e+" input:file").trigger("click")})}}}]);
attachMediaModule.directive("imageonload",function(){return{restrict:"AE",scope:!0,require:"^isolate",controller:["$scope","ImagesStorage",function(a,b){a.imgsStorage=b}],link:function(a,b,e,d){a.isolateMediaController=d;var c=b.attr("data-id-editor"),g=b.attr("data-type-preview");b.bind("load",function(){if("large"==g)a.imgsStorage.add(a.imgsStorage.countItems+1,$(this).attr("src"),"big"),$(this).css("display","none").removeClass("load_here"),a.isolateMediaController.setActive(!0),a.$apply();else if("small"==
g)a.imgsStorage.add(a.imgsStorage.countItems+1,$(this).attr("src"),"small"),$(this).css("display","none").removeClass("load_here"),a.isolateMediaController.setActive(!0),a.$apply();else{var b=$('<a  href="'+$(this).attr("src")+'"></a>'),d=$('<img style="display:inline;" src="'+$(this).attr("src")+'">').width("50px").height("50px");b.append(d);$("#"+c).append(b);$(this).css("display","none").removeClass("load_here");$("#"+c).focusEnd()}})}}});
attachMediaModule.directive("imagePreview",["chatConfig",function(a){return{restrict:"AE",scope:{typePreview:"@"},require:"^isolate",templateUrl:a.domenApp+"/lib/js/angular/apps/chat/partials/image_preview.html",link:function(a,e,d,c){a.isolateMediaController=c},controller:["$scope","$element","ImagesStorage",function(a,e,d){a.infoFullStack=!1;a.showMediaContainer=!1;a.showPreloader=!1;a.showImagePreview=!1;a.bnspan="";a.imgsStorage=d;a.$watch("imgsStorage.countItems",function(c,d){c!=d&&void 0!=
c&&(a.isolateMediaController.getActive()?(a.showImageContainer=a.imgsStorage.countItems?!0:!1,a.showPreloader=!0,"large"==a.typePreview?a.bnspam=1!=a.imgsStorage.countItems?"span4":"span8":"small"==a.typePreview&&(a.bnspam="span1"),a.showImagePreview=a.imgsStorage.countItems?!0:!1,a.showPreloader=!1,a.isolateMediaController.setActive(!1)):a.showImageContainer=!1)});a.$watch("imgsStorage.isFull",function(c,d){c!=d&&void 0!=c&&a.isolateMediaController.getActive()&&(a.infoFullStack=!0)});a.delItem=function(c){a.imgsStorage.remove(c)};
a.generateEnterEvent=function(){a.$parent.sendMsg($.Event("keypress",{which:13}),a.$parent.partnerInfo.id)}}]}}]);
attachMediaModule.directive("mediaPreview",["chatConfig",function(a){return{restrict:"AE",scope:!0,require:"^isolate",templateUrl:a.domenApp+"/lib/js/angular/apps/chat/partials/media_preview.html",link:function(a,e,d,c){a.isolateMediaController=c},controller:["$scope","MediaAPI",function(a,e){a.showMediaPreview=!1;a.showMediaContainer=!1;a.showPreloader=!1;a.showMimgPreview=!0;a.api=e;a.$watch("api.isStart",function(d,c){d!=c&&void 0!=d&&(a.isolateMediaController.getActive()?(a.showMediaContainer=
a.api.isStart?!0:!1,a.showPreloader=a.api.isStart?!0:!1):a.showMediaContainer=!1)});a.$watch("api.mediaContent",function(d,c){d!=c&&d&&a.isolateMediaController.getActive()&&(a.showMediaPreview=!0,a.showPreloader=!1)});a.delImage=function(){a.api.mediaContent.image=null;a.showMimgPreview=!1};a.delMediaPreview=function(){a.api.mediaContent=null;a.showMediaContainer=!1;a.api.isload=!1}}]}}]);
attachMediaModule.directive("pasteMedia",function(){return{restrict:"AE",scope:!0,require:"^isolate",controller:["$scope","MediaAPI",function(a,b){a.api=b}],link:function(a,b,e,d){a.isolateMediaController=d;b.bind("paste",function(c){a.api.isload||(c=(c.originalEvent||c).clipboardData.getData("text/plain")||prompt("Error paste.."),a.api.isContentSpecificUrl(c)&&(a.api.getMediaContent(a.api.urlMedia),a.isolateMediaController.setActive(!0),a.$apply()))})}}});
attachMediaModule.directive("msgAttach",["chatConfig",function(a){return{template:'<ng-include src="getTemplateUrl()"/>',scope:{attach:"=iattach",vtype:"@"},restrict:"E",controller:["$scope",function(b){b.chatBigAttach=a.domenApp+"/lib/js/angular/apps/chat/partials/msg-attach.html";b.chatSmallAttach=a.domenApp+"/lib/js/angular/apps/chat/partials/e-msg-attach.html";b.getTemplateUrl=function(){if("chatBig"==b.vtype)return b.chatBigAttach;if("chatSmall"==b.vtype)return b.chatSmallAttach}}]}}]);var chatApp=angular.module("chatApp",["ngRoute","ui.bootstrap","notification","mediaModule"]);chatApp.constant("chatConfig",tatetChat);
chatApp.config(["$sceDelegateProvider","$routeProvider","$locationProvider","chatConfig",function(a,b,e,d){a.resourceUrlWhitelist(["**"]);b.when("/chat/contacts/:type",{templateUrl:d.domenApp+"/lib/js/angular/apps/chat/partials/list_contacts.html",controller:"contactsController"}).when("/chat/messages/dialogs",{templateUrl:d.domenApp+"/lib/js/angular/apps/chat/partials/list_dialogs.html",controller:"dialogsController"}).when("/chat/messages/dialogs/:accountId",{templateUrl:d.domenApp+"/lib/js/angular/apps/chat/partials/list_dialogs.html",
controller:"dialogsController"}).when("/chat/messages/dialog/:accountId/:contactId/:type",{templateUrl:d.domenApp+"/lib/js/angular/apps/chat/partials/dialog.html",controller:"dialogController"}).when("/chat/messages/create_msg/accountId/:accountId/invitedId/:invitedId",{templateUrl:d.domenApp+"/lib/js/angular/apps/chat/partials/create_msg.html",controller:"msgController"}).when("/chat/messages/create_msg/accountId/:accountId/id/:id/typeContact/:typeContact",{templateUrl:d.domenApp+"/lib/js/angular/apps/chat/partials/create_msg.html",
controller:"msgController"}).when("/chat/messages/create_msg/accountId/:accountId",{templateUrl:d.domenApp+"/lib/js/angular/apps/chat/partials/create_msg.html",controller:"msgController"}).when("/chat/messages/create_msg/",{templateUrl:d.domenApp+"/lib/js/angular/apps/chat/partials/create_msg.html",controller:"msgController"}).when("/chat/messages/group/action/:action/params/:params",{templateUrl:d.domenApp+"/lib/js/angular/apps/chat/partials/group.html",controller:"groupController"}).when("/chat/forward/aid/:aid/cid/:cid/cty/:cty/ity/:ity",
{templateUrl:d.domenApp+"/lib/js/angular/apps/chat/partials/forward-msg.html",controller:"forwardController"}).when("/echat",{templateUrl:d.domenApp+"/lib/js/angular/apps/chat/partials/echat.html",controller:"echatController"}).otherwise({redirectTo:function(){console.log(window.location.hash)}});"undefined"!=typeof d.chatProfile&&0==parseInt(d.chatProfile)&&e.html5Mode({enabled:!0,requireBase:!1,rewriteLinks:!1})}]);var Khmerload=Khmerload||{};
Khmerload.SharedWebSocket=function(a){function b(){var a=localStorage.getItem(n);if(null===a)return!1;a=parseInt(a);return Date.now()-a>o?!1:!0}function e(){b()||d()}function d(){if(b())return!1;localStorage.setItem(q,j);localStorage.setItem(n,Date.now());f=!0;null!==h&&clearInterval(h);m=setInterval(function(){localStorage.setItem(n,Date.now())},l);setTimeout(function(){f&&("function"==typeof a.master&&a.master(),c())},500)}function c(){k=new Khmerload.NativeWebSocket({url:a.url,open:function(){g("OPEN");
"function"==typeof a.open&&a.open()},message:function(c){g("MSG "+c);"function"==typeof a.message&&a.message(c)},close:function(){g("CLOSE");"function"==typeof a.close&&a.close()},reconnect:a.reconnect})}function g(a){localStorage.setItem(r,Date.now()+" "+a)}var f=!1,j=Date.now()+parseInt(500*Math.random()),h=null,m=null,l=3E3,o=5E3,k=null,p="wss_"+function(a){var c=0,b,f,d;if(0==a.length)return c;b=0;for(d=a.length;b<d;b++)f=a.charCodeAt(b),c=(c<<5)-c+f,c|=0;return c}(a.url),r=p+"_forward",n=p+"_timestamp",
q=p+"_master";(function(){for(var a=Date.now()-86400,c=/^wss_\-?\d+_(forward|master|timestamp)/,b=Object.keys(localStorage),f=b.length;f--;)b[f].match(c)&&localStorage.getItem(b[f])&&parseInt(localStorage.getItem(b[f]))<a&&localStorage.removeItem(b[f])})();this.getID=function(){return j};this.send=function(a){f?k.send(a):g("SEND "+a)};window.addEventListener("storage",function(c){if(c.key==q){var b=parseInt(c.newValue);f&&b<j&&(f=!1,h=setInterval(e,7E3),null!==m&&clearInterval(m))}if(c.key==r){var b=
c.newValue,d=b.indexOf(" ");if(!(0>d))if(b=b.substr(d+1),d=b.indexOf(" "),c=0>d?b:b.substr(0,d),b=0>d?"":b.substr(d+1),"MSG"===c){c=b;a:{try{JSON.parse(b)}catch(g){d=!1;break a}d=!0}d&&(c=JSON.parse(b),c.childChat=1,c=JSON.stringify(c));"function"==typeof a.message&&a.message(c)}else"SEND"===c?f&&k.send(b):"OPEN"===c?"function"==typeof a.open&&a.open():"CLOSE"===c&&"function"==typeof a.close&&a.close()}});b()||d();f||(h=setInterval(e,7E3));return this};
Khmerload.ReconnectStrategy=function(a){var b=0;this.reset=function(){b=0};this.next=function(e){a.constructor===Array?b<a.length&&(setTimeout(e,a[b]),b++):"number"===typeof a&&setTimeout(e,a)}};
Khmerload.NativeWebSocket=function(a){function b(){var d=new WebSocket(a.url);d.onerror=function(){"function"===typeof a.error&&a.error()};d.onmessage=function(c){"function"===typeof a.message&&a.message(c.data)};d.onclose=function(){"function"===typeof a.close&&a.close();e.next(b)};d.onopen=function(){"function"===typeof a.open&&a.open();e.reset()};return d}"undefined"===typeof a.reconnect&&(a.reconnect=!1);var e=new Khmerload.ReconnectStrategy(a.reconnect);return b()};$.fn.focusEnd=function(){$(this).focus();var a=$("<span />").appendTo($(this)),b=a.get(0),e=null,d=null;document.selection?(e=document.body.createTextRange(),e.moveToElementText(b),e.select()):window.getSelection&&(e=document.createRange(),e.selectNode(b),d=window.getSelection(),d.removeAllRanges(),d.addRange(e));a.remove();return this};chatApp.service("msgStorage",function(){var a="";return{setMsg:function(b){a=b},getMsg:function(){return a}}});chatApp.factory("chatService",["$http","$sce","$q","chatConfig",function(a,b,e,d){return{scrollPosListDialogs:0,countNewMsg:0,stackNewMsgs:[],tagImgToCode:1,codeToTagImg:2,tagAToCode:3,codeToTagA:4,textAToCode:5,textHrefToTagA:6,dataLoaded:!1,typeContact:{Alone:"alone",Group:"group",Support:"support"},getInfoContact:function(c,b,f){return a.get("/profile/"+d.myId+"/getInfoChatContact/",{params:{accountId:c,contactId:b,typeContact:f}})},getInfoChatContactMembers:function(c){if("undefined"!=typeof c)return a.get("/profile/"+
d.myId+"/getInfoChatContactMembers/",{params:{members:angular.toJson(c)}})},getContactByMembers:function(c,b){return a.get("/profile/"+d.myId+"/getContactByMembers/",{params:{accountId:c,invitedId:b}})},getContactByShop:function(c,b){return a.get("/profile/"+d.myId+"/getContactByShop/",{params:{accountId:c,shopId:b}})},getCommonGroups:function(c,b){return a.get("/profile/"+d.myId+"/getCommonGroups/",{params:{mid:c,fid:b}})},createGroup:function(c,b,f,e,h){return a.get("/profile/"+d.myId+"/createGroup/",
{params:{accountId:c,nameGroup:b,logoGroup:f,members:e,thread_hash:h}})},isSP:function(){return 1==parseInt(d.sp)?!0:!1},renderHtml:function(a){return b.trustAsHtml(a)},urlify:function(a){a=a.replace(/&nbsp;/img," ");return a.replace(/([^href="]https?:\/\/[^\s]+)/img,function(a){return'<a href="'+a+'" target="_blank" rel="nofollow">'+a+"</a>"})},transformTag:function(a,b){switch(b){case this.tagImgToCode:a=a.replace(/(&lt;|<)a.*?(&gt;|>)(&lt;|<)img.*?src="(.*?)".*?(&gt;|>)(&lt;|<)\/a(&gt;|>)/img,
"[i]$4[/i]");a=jQuery.mbEmoticons.replaceImgTagByCode(a);break;case this.codeToTagImg:a=a.replace(/\[i\](.*?)\[\/i\]/img,'<a href="$1" target="_blank" rel="nofollow"><img style="display: inline; width: 19px; height: 19px;" src="$1"></a>');a=jQuery.mbEmoticons.replaceByImage(a,!0);break;case this.tagAToCode:a=a.replace(/(&lt;|<)a.*? href="([^"]*)"(.*?)(&gt;|>)(.*?)(&lt;|<)\/a(&gt;|>)/img,"[a][h]$2[/h][c]$5[/c][/a]");break;case this.codeToTagA:a=a.replace(/\[a\]\[h\](.*?)\[\/h\]\[c\](.*?)\[\/c\]\[\/a\]/img,
'<a href="$1" target="_blank" rel="nofollow">$2</a>');break;case this.textHrefToTagA:a=a.replace(/&amp;nbsp;/g,"\u00a0"),a=this.urlify(a)}return a},translateStatus:function(a){switch(a){case "delete":return"\u0443\u0434\u0430\u043b\u0435\u043d\u043d\u044b\u0439 \u043a\u043e\u043d\u0442\u0430\u043a\u0442";case "block":return"\u0431\u043b\u043e\u043a\u0438\u0440\u043e\u0432\u0430\u043d\u043d\u044b\u0439 \u043a\u043e\u043d\u0442\u0430\u043a\u0442";case "cancel":return"\u043e\u0442\u043c\u0435\u043d\u0435\u043d\u043d\u044b\u0439 \u043a\u043e\u043d\u0442\u0430\u043a\u0442";
case "accepted":return"\u043f\u043e\u0434\u0442\u0432\u0435\u0440\u0436\u0434\u0435\u043d\u043d\u044b\u0439 \u043a\u043e\u043d\u0442\u0430\u043a\u0442";case "no_accepted":return"\u043d\u0435\u043f\u043e\u0434\u0442\u0432\u0435\u0440\u0436\u0434\u0435\u043d\u043d\u044b\u0439 \u043a\u043e\u043d\u0442\u0430\u043a\u0442";case "new":return"\u043d\u043e\u0432\u044b\u0439 \u043a\u043e\u043d\u0442\u0430\u043a\u0442"}},prepareMsg:function(a,b){var f="";switch(b){case 0:f=this.transformTag(a,this.tagImgToCode);
f=this.transformTag(f,this.tagAToCode);f=this.transformTag(f,this.textAToCode);break;case 1:f=this.transformTag(a,this.codeToTagImg),f=this.transformTag(f,this.codeToTagA),f=this.transformTag(f,this.textHrefToTagA)}return f},isJson:function(a){try{JSON.parse(a)}catch(b){return!1}return!0},viewProfile:function(a,b,f){a.preventDefault();switch(b){case "shop":window.location.href=d.domenApp+"/shop/"+f.id_external;break;case "customer":case "team":window.location.href="undefined"!=typeof f.members?d.domenApp+
"/profile/"+f.members[0]:d.domenApp+"/profile/"+f.id}},getPartial:function(a,b){0<a.length&&(a+="/");return d.domenApp+"/lib/js/angular/apps/chat/partials/"+a+b}}}]);chatApp.factory("socketService",["chatConfig",function(a){var b={callbackStack:[],events:{popen:"open",pclose:"close",ponline:"online",pmessage:"message",iwriting:"info-writing-msg",sinfoAcceptedChat:"support-inform-accepted-chat",sinfoNotAcceptedChat:"support-inform-not-accepted-chat",sforwardManager:"support-forward-manager",sforwardAccount:"support-forward-account",sinformUserForwardAccount:"inform-user-forward-account",sinformStateSupportContactsManagement:"inform-state-support-contacts-management",
sreportChat:"report-chat",gopen:"gopen"},connect:function(a){this.ws||(this.ws=new Khmerload.SharedWebSocket({url:a,message:function(a){for(index in b.callbackStack)b.callbackStack[index](a)}}))}},e=$.cookie("PHPSESSID")?$.cookie("PHPSESSID"):$.cookie("tatet");b._wurl="wss://tatet.ua:8009/hash="+e+"&userId="+a.myId+"&muacc="+a.muacc;b.createConnect=function(){this.connect(this._wurl)};b.send=function(a){this.ws.send(a)};b.subscribe=function(a){this.callbackStack.push(a)};return b}]);chatApp.factory("online",["$rootScope","socketService","chatService","msgsManager","support",function(a,b,e,d,c){var g={onlineUsers:[],allOnlineCommunity:[],countAllOnlines:0,countOnlineUsers:0,setOnline:function(c){var b=this;c.forEach(function(a){0>b.onlineUsers.indexOf(""+a)&&b.onlineUsers.push(a)});b.countOnlineUsers=b.onlineUsers.length;a.$apply()},unsetOnline:function(c){0<=this.onlineUsers.indexOf(c)&&this.onlineUsers.splice(this.onlineUsers.indexOf(c),1);this.countOnlineUsers=this.onlineUsers.length;
a.$apply()},getOnlineUsers:function(a){var c=this,b=[];"undefined"!=typeof a&&a.forEach(function(a){0<=c.onlineUsers.indexOf(""+a)&&b.push(a)});return b},setAllOnlineCommunity:function(c){g.countAllOnlines=Object.keys(c).length;g.allOnlineCommunity=c;a.$apply()},init:function(){b.subscribe(function(a){e.isJson(a)&&(a=angular.fromJson(a));switch(a.event){case b.events.popen:var j=[a.userId];g.setOnline(j);break;case b.events.pclose:g.unsetOnline(a.userId);break;case b.events.ponline:j=a.onlineUsers;
g.setOnline(j);c.setAnchoredManagerContacts(a.supportInfo);break;case b.events.pmessage:d.addToNotify({accountId:a.accountId,contactId:a.contactId,typeContact:a.typeContact,msg:a.msg,isInternal:0,childChat:"undefined"==typeof a.childChat?0:1});break;case b.events.iwriting:d.notifyWritingMsg(a.iswriting);break;case b.events.sinfoAcceptedChat:c.pushMsgInThread(a.msgdata);c.assignTalkManager(a.manager,a.accountId,a.contact);break;case b.events.sinfoNotAcceptedChat:c.pushMsgInThread(a.msgdata);c.unassignTalkManager(a.manager,
a.accountId,a.contact);break;case b.events.sforwardManager:d.addToNotify({accountId:a.accountId,contactId:a.contact.id,typeContact:a.contact.type,msg:a.msgdata,isInternal:1});c.changeTalkManager(a.prevManager,a.nextManager,a.accountId,a.contact);break;case b.events.sforwardAccount:d.addToNotify({accountId:a.nextAccountId,contactId:a.nextContact.id,typeContact:a.nextContact.type,msg:a.msg,isInternal:1});c.addCopiesInThread(a.nextContact,a.copies);c.changeTalkAccount(a.prevAccountId,a.nextAccountId,
a.prevManager,a.nextManager,a.prevContact,a.nextContact);break;case b.events.sinformUserForwardAccount:j=d.formatMsg(a.nextContact.id,a.nextContact.type,'\u0434\u043b\u044f \u043f\u0440\u043e\u0434\u043e\u043b\u0436\u0435\u043d\u0438\u044f \u043e\u0431\u0449\u0435\u043d\u0438\u044f \u043f\u043e \u0434\u0430\u043d\u043d\u043e\u0439 \u0442\u0435\u043c\u0430\u0442\u0438\u043a\u0435 \u0432\u0430\u043c \u043d\u0435\u043e\u0431\u0445\u043e\u0434\u0438\u043c\u043e \u043e\u0431\u0440\u0430\u0442\u0438\u0442\u044c\u0441\u044f <a href="" ng-click="goToDialog('+
a.nextContact.id+",'alone')\">"+a.nextAccount.name+"</a>",a.nextAccount.id,a.receiverId);d.addToNotify({accountId:a.currentAccountId,contactId:a.contact.id,typeContact:a.contact.type,msg:j,isInternal:1});break;case b.events.sinformStateSupportContactsManagement:c.setAnchoredManagerContacts(a.scm);break;case b.events.sreportChat:g.setAllOnlineCommunity(a.onlines)}});b.createConnect()}};return g}]);chatApp.factory("searchService",["$http","$sce","$q","chatConfig",function(a,b,e,d){return{selectContacts:[],names:void 0,asyncSelected:null,getContacts:function(c,b,e){var j=this;"undefined"==typeof e&&(e=0);return a.get("/profile/"+d.myId+"/searchChatContact/",{params:{search:c,searchGroups:b,type:e}}).then(function(a){return j.names=a.data},function(){console.log("Error: getContacts")})},selectMatch:function(a){this.asyncSelected=this.names[a]},removeFromSelects:function(a){this.selectContacts.splice(a,
1)}}}]);chatApp.factory("Account",["$http","chatConfig","contactsManager",function(a,b,e){function d(a){a&&this.setData(a)}d.prototype={managers:[],setData:function(a){angular.extend(this,a)},getContact:function(a,b){return e.getContact(this.id,a,b)},getContacts:function(a){return e.loadAll(this.id,"undefined"==typeof a?e.which.all:a)},getSpecificContacts:function(a){return e.loadAll(this.id,a)},setManagers:function(a){var b=this;angular.forEach(a,function(a){b.managers.push({id:a.id,name:a.name})})},getManagers:function(){return this.managers}};
return d}]);
chatApp.factory("accountsManager",["$http","$q","Account","chatConfig","contactsManager",function(a,b,e,d){return{_pool:{},_retrieveInstance:function(a,b){var d=this._pool[a];d?d.setData(b):(d=new e(b),this._pool[a]=d);return d},_search:function(a){return this._pool[a]},loadAll:function(){var c=b.defer(),e=this,f=[];0<Object.keys(e._pool).length?(angular.forEach(e._pool,function(a){f.push(a)}),c.resolve(f)):a.get("/profile/"+d.myId+"/getChatAccounts/").success(function(a){a.forEach(function(a){a=e._retrieveInstance(a.id,
a);f.push(a)});c.resolve(f)}).error(function(){c.reject()});return c.promise},getFirst:function(){return this._pool[Object.keys(this._pool)[0]]},getAccount:function(a){return this._search(a)},countAccounts:function(){return Object.keys(this._pool).length},isMultiAccounts:function(){return 1<this.countAccounts()?!0:!1},getAccountManagers:function(c){var e=b.defer(),f=this,j=f._pool[c].getManagers();void 0!=typeof j&&0<j.length?e.resolve(f._pool[c].getManagers()):a.get("/profile/"+d.myId+"/getAccountManagers/",
{params:{accountId:c}}).success(function(a){f._pool[c].setManagers(a);e.resolve(f._pool[c].getManagers())}).error(function(){e.reject()});return e.promise}}}]);chatApp.factory("Contact",["$http","chatConfig","msgsManager","chatService",function(a,b,e,d){function c(a){a.inOnline=!1;switch(a.type){case "group":a.onlineMembers=[],a.onlineMembersInfo=[],a.visibleGroupMembers=!1}a&&this.setData(a)}c.prototype={setData:function(a){angular.extend(this,a)},getMsgs:function(a){return e.loadAll(this.accountId,this.id,this.type,a)},update:function(){return 1},loadGroupMembers:function(){var a=this;"group"==a.type&&(0==a.onlineMembersInfo.length&&0<a.onlineMembers.length&&
d.getInfoChatContactMembers(a.onlineMembers).success(function(c){angular.forEach(c,function(c){a.onlineMembersInfo.push(c)})}),a.visibleGroupMembers=!a.visibleGroupMembers)}};return c}]);
chatApp.factory("contactsManager",["$http","$q","Contact","chatConfig",function(a,b,e,d){return{which:{all:"all",own:"own",other:"other"},type:{alone:"alone",group:"group",support:"support"},_pool:{},_retrieveInstance:function(a,b,d){var j=void 0;this._pool[a]&&(j=this._pool[a][d.type+b]);"undefined"!=typeof j?j.setData(d):(d.accountId=a,j=new e(d),this._pool[a]||(this._pool[a]={}),this._pool[a][d.type+b]=j);return j},loadOne:function(c,b,e){return a.get("/profile/"+d.myId+"/getChatOneContact/",{params:{accountId:c,
contactId:b,contactType:e}})},_search:function(a,d,e){var j=b.defer(),h=this,m=null;if("undefined"!=typeof h._pool[a]&&"undefined"!=typeof h._pool[a][e+d])return m=h._pool[a][e+d],j.resolve(m),j.promise;h.loadOne(a,d,e).success(function(b){m=h._retrieveInstance(a,b.id,b);j.resolve(m)}).error(function(){j.reject()});return j.promise},countAll:function(c){return a.get("/profile/"+d.myId+"/getCountContacts/",{params:{accountId:c}})},countLocal:function(a){var b=0,d=this;d._pool[a]&&angular.forEach(d._pool[a],
function(a){a.type!=d.type.support&&b++});return b},loadAll:function(c,e){"undefined"==typeof e&&(e="all");var f=b.defer(),j=this,h=[];j.countAll(c).then(function(b){var b=b.data.count,l=j.countLocal(c);0<parseInt(b)&&parseInt(b)==parseInt(l)&&"all"==e?(angular.forEach(j._pool[c],function(a){h.push(a)}),f.resolve(h)):a.get("/profile/"+d.myId+"/getChatAccountContacts/",{params:{accountId:c,which:e}}).success(function(a){a.forEach(function(a){a=j._retrieveInstance(c,a.id,a);h.push(a)});f.resolve(h)}).error(function(){f.reject()})});
return f.promise},getContact:function(a,b,d){return this._search(a,b,d)},setOnlineStatus:function(a,b){angular.forEach(this._pool[a],function(a){a.inOnline=!1;a.onlineMembersInfo=[];a.onlineMembers=[];angular.forEach(a.members,function(c){0<=b.indexOf(c)&&(a.inOnline=!0,a.onlineMembers.push(c))})})},isOnline:function(a,b){return this.getContact(a,b).inOnline},findNewShops:function(c,e){var f=[];angular.forEach(e,function(a){f.push(a)});b.defer();return a.get("/profile/"+d.myId+"/findNewShopsInChat/",
{params:{accountId:c,ids:angular.toJson(f)}})}}}]);chatApp.factory("Message",["$http","chatConfig",function(){function a(a){a&&this.setData(a)}a.prototype={setData:function(a){angular.extend(this,a)}};return a}]);
chatApp.factory("msgsManager",["$http","$q","$rootScope","Message","chatConfig","chatService","MediaAPI","ImagesStorage","socketService",function(a,b,e,d,c,g,f,j,h){return{waitingMsg:!1,iswritingNow:!1,countNewMsg:0,notifyMsg:0,notifyMsgHash:[],showThread:0,stackNewMsgs:{},stackNotifyMsg:[],supportActionForMessage:{accept:"accept",notAccept:"not_accept",redirect:"redirect",acceptRedirect:"accept_redirect"},_retrieveInstance:function(a,c){c.msg=g.prepareMsg(c.msg,1);c.msgSelected=!1;c.answered=!1;
return instance=new d(c)},loadAll:function(d,e,f,k){"undefined"==typeof k&&(which="default");var g=b.defer(),h=this;a.get("/profile/"+c.myId+"/getChatContactMsgs/",{params:{accountId:d,contactId:e,typeContact:f,period:k}}).success(function(a){var c=[];a.msgs&&a.msgs.forEach(function(a){a.contactId=e;a=h._retrieveInstance(a.id,a);c.push(a)});g.resolve({msgs:c,personalInfoContact:a.personalInfoContact})}).error(function(){g.reject()});return g.promise},_send:function(d,e){var f=b.defer(),k=this,h=k.prepareAttach();
if(5>h.length&&!e.msg)return null;e.attach=h;a.get("/profile/"+c.myId+"/"+d+"/",{params:e}).then(function(a){var a=a.data,c=!1;angular.forEach(a.objs,function(a){a.error||(a.entity.msg=g.prepareMsg(a.entity.msg,1),k.sendWebSocketPacket(a.entity),c=!0)});if(c){if(0<Object.keys(k.stackNewMsgs).length){var b=a.objs[0].entity.type+a.objs[0].entity.contactId;"undefined"!=typeof k.stackNewMsgs[b]&&(k.countNewMsg-=parseInt(k.stackNewMsgs[b].count_msgs),delete k.stackNewMsgs[b])}b={};b.info_msg=a.report.info;
b.entity=a.objs[0].entity;f.resolve(b)}else f.reject()});return f.promise},sendMsg:function(a,c,b){return this._send("sendMsg",{accountId:a,receivers:angular.toJson(b),msg:g.prepareMsg(c,0)})},sendWebSocketPacket:function(a){var c=a.type==g.typeContact.Alone?a.receiver_id:0,b=a.contactId;a.support=[];h.send(JSON.stringify({receiver:c,contactId:b,typeContact:a.type,msg:a,event:"message"}))},prepareAttach:function(){var a=[];f.mediaContent&&(a=a.concat(f.mediaContent),f.mediaContent=null,f.isStart=
!1);0<j.items.length&&(a=a.concat(j.items),j.items=[],j.countItems=0);return angular.toJson(a)},addAmountNewMsgs:function(a,c){var b=!1,d=c.contact_type+c.contactId;this.countNewMsg+=parseInt(c.count_msgs);0<Object.keys(this.stackNewMsgs).length&&angular.forEach(this.stackNewMsgs,function(e,f){d==f&&(e.count_msgs=parseInt(e.count_msgs)+parseInt(c.count_msgs),e.msg.push(c.msg),e.isInternal=c.isInternal,0>e.accountIds.indexOf(parseInt(a))&&e.accountIds.push(parseInt(a)),b=!0)});b||(this.stackNewMsgs[d]=
{accountIds:[parseInt(a)],accountId:a,contactId:c.contactId,contactType:c.contact_type,name:c.name,logo:c.logo,msg:[c.msg],count_msgs:c.count_msgs,isInternal:c.isInternal})},addToNotify:function(a){var c=this;g.getInfoContact(a.accountId,a.contactId,a.typeContact).success(function(b){c.stackNotifyMsg.push({accountId:a.accountId,contactId:a.contactId,contact_type:a.typeContact,name:b.name,logo:b.logo,msg:a.msg,count_msgs:1,isInternal:a.isInternal,childChat:a.childChat});c.notifyMsg+=1})},getCountNewMsgsContact:function(a,
c,b){a=a+b+c;return"undefined"!=typeof this.stackNewMsgs[a]?this.stackNewMsgs[a].count_msgs:0},setViewed:function(a,c){if(0<Object.keys(this.stackNewMsgs).length){var b=null,b=0==a&&""==c?this.stackNewMsgs[Object.keys(this.stackNewMsgs)[0]]:this.stackNewMsgs[c+a];return this.loadAll(b.accountIds[b.accountIds.length-1],b.contactId,b.contactType,"default").then(function(a){a.viewInfo={accountId:b.accountIds[b.accountIds.length-1],contactId:b.contactId,contactType:b.contactType};return a})}return[]},
clearNew:function(a,c){"undefined"!=typeof this.stackNewMsgs[c+a]&&delete this.stackNewMsgs[c+a]},loadNewMsgs:function(){var b=this;a.get("/profile/"+c.myId+"/getNewMsgs/").success(function(a){angular.forEach(a,function(a){angular.forEach(a.newmsgs,function(c){b.addAmountNewMsgs(a.accountId,c)})})})},eSelectMsgs:{},eHasSelected:!1,toggleSelectMsg:function(a){"undefined"==typeof this.eSelectMsgs[parseInt(a.id)]?this.eSelectMsgs[parseInt(a.id)]=a.msg:delete this.eSelectMsgs[parseInt(a.id)];this.eHasSelected=
0<Object.keys(this.eSelectMsgs).length},eGetIdSelectMsgs:function(){var a=[];angular.forEach(this.eSelectMsgs,function(c,b){a.push(b)});return a},eGetSelectMsgs:function(){var a=[];angular.forEach(this.eSelectMsgs,function(c){a.push(c)});return a},eClearSelectMsgs:function(){this.eSelectMsgs={};this.eHasSelected=!1},ecountSelectedMsgs:function(){return this.eHasSelected?Object.keys(this.eSelectMsgs).length:0},updateStatus:function(d,e,f){var k=b.defer(),f=angular.toJson(f);a.get("/profile/"+c.myId+
"/updateStatusMsgs/",{params:{accountId:d,ids:f,status:e}}).success(function(a){k.resolve(a.error)}).error(function(){k.reject()});return k.promise},formatMsg:function(a,c,b,d,e){return{id:0,contactId:a,thread_hash:a,type:c,sender_id:d,receiver_id:e,msg:b,is_answered:0,is_viewed:0,date_created:0,group_id:0,is_internal:1,is_copy:0}},informTypedMsg:function(a,c){h.send(JSON.stringify({companion:a.id,iswriting:c,event:"info-writing-msg"}))},notifyWritingMsg:function(a){this.waitingMsg=!this.waitingMsg;
this.iswritingNow=a;e.$apply()}}}]);chatApp.factory("onlineShop",["$q","$http","online","chatConfig",function(a,b,e,d){return{flag:!1,managers:[],getManagersShop:function(c){var e=a.defer(),f=this;f.managers.length?e.resolve(f.managers):b.post("/profile/"+d.myId+"/getIdManagerShop/?shopId="+c).success(function(a){a.error||(f.managers=a.list,e.resolve(a.list))}).error(function(){e.reject()});return e.promise}}}]);chatApp.service("audio",function(){var a;return{play:function(){null!=a&&a.pause();a=new Audio;a.src="/lib/js/angular/apps/chat/audio/chat-zp3.mp3";a.autoplay=!0;a.controls=!0}}});chatApp.factory("Tool",["$http","audio","$notification","chatConfig",function(a,b,e,d){function c(a){this.nameSettings=g;a&&this.setData(a)}var g={soundNotification:"ch_sound_notification",notifyInPanel:"ch_notify_in_panel"};c.prototype={setData:function(a){angular.extend(this,a)},update:function(){var c=this;a.get("/profile/"+d.myId+"/changeToolChat/?idTool="+c.id+"&attributes="+JSON.stringify(c)).success(function(a){a.error||c.getState()&&e("\u041e\u043f\u043e\u0432\u0435\u0449\u0435\u043d\u0438\u0435 \u0432\u043a\u043b\u044e\u0447\u0435\u043d\u043e",
{body:"",delay:2E3})})},getState:function(){switch(this.type){case "checkbox":return this.getStateCheckbox(this.value)}},getStateCheckbox:function(a){return"on"==a?!0:!1}};return c}]);
chatApp.factory("toolsManager",["$http","$q","Tool","chatConfig",function(a,b,e,d){return{_pool:{},audioNotify:1,notifyPanel:2,_retrieveInstance:function(a,b){var d=this._pool[a];d?d.setData(b):(d=new e(b),this._pool[a]=d);return d},_search:function(a){return this._pool[a]},loadAllTools:function(){var c=b.defer(),e=this;a.get("/profile/"+d.myId+"/getToolsChat/").success(function(a){var b=[];a.forEach(function(a){a=e._retrieveInstance(a.id,a);b.push(a)});c.resolve(b)}).error(function(){c.reject()});
return c.promise},getTool:function(a){return this._search(a)}}}]);chatApp.factory("support",["$http","$q","chatConfig","chatService","socketService","accountsManager","contactsManager","msgsManager",function(a,b,e,d,c,g,f,j){return{supportsCache:[],hasInternalMsg:!1,internalMsg:null,getSupports:function(){var c=b.defer(),d=this;0<d.supportsCache.length?c.resolve(d.supportsCache):a.get("/profile/"+e.myId+"/getSupports/").success(function(a){d.supportsCache=a;c.resolve(d.supportsCache)}).error(function(){c.reject()});return c.promise},createCopyMsgs:function(c,b,
d,f){return a.get("/profile/"+e.myId+"/copyMsgs/",{params:{accountId:c,copyForAccountId:b,copyForManagerId:d,msgIds:angular.toJson(f)}})},acceptChat:function(a,b,e,f){d.isSP()&&this.sendInternalMsg(b,e,f,"\u041c\u0435\u043d\u0435\u0434\u0436\u0435\u0440 "+a.name+" \u043d\u0430\u0447\u0430\u043b \u0434\u0438\u0430\u043b\u043e\u0433 \u0441 \u043a\u043b\u0438\u0435\u043d\u0442\u043e\u043c").then(function(k){k=k.data;k.objs[0].error||(k=k.objs[0].entity,k.msg=d.prepareMsg(k.msg,1),c.send(JSON.stringify({event:"support-accepted-chat",
manager:a,accountId:b,contact:{id:e,type:f},msg:k})))})},notAcceptChat:function(a,b,e,f){d.isSP()&&this.sendInternalMsg(b,e,f,"\u041c\u0435\u043d\u0435\u0434\u0436\u0435\u0440 "+a.name+" \u043e\u0442\u043a\u0430\u0437\u0430\u043b\u0441\u044f \u043f\u0440\u043e\u0434\u043e\u043b\u0436\u0430\u0442\u044c \u0434\u0438\u0430\u043b\u043e\u0433 \u0441 \u043a\u043b\u0438\u0435\u043d\u0442\u043e\u043c").then(function(k){k=k.data;k.objs[0].error||(k=k.objs[0].entity,k.msg=d.prepareMsg(k.msg,1),c.send(JSON.stringify({event:"support-not-accepted-chat",
manager:a,accountId:b,contact:{id:e,type:f},msg:k})))})},forwardManager:function(a,b,e,f,k){d.isSP()&&this.sendInternalMsg(e,f,k,"\u041c\u0435\u043d\u0435\u0434\u0436\u0435\u0440 "+a.name+" \u043f\u0435\u0440\u0435\u0434\u0430\u043b \u0434\u0438\u0430\u043b\u043e\u0433 \u043c\u0435\u043d\u0435\u0434\u0436\u0435\u0440\u0443 "+b.name).then(function(g){g=g.data;g.objs[0].error||(g=g.objs[0].entity,g.msg=d.prepareMsg(g.msg,1),c.send(JSON.stringify({event:"support-forward-manager",currentManager:a,nextManager:b,
accountId:e,contact:{id:f,type:k},msg:g})))})},forwardAccount:function(a,b,e,g,k,p,r){if(d.isSP()){var n=this;n.sendInternalMsg(e,k,p,"\u041c\u0435\u043d\u0435\u0434\u0436\u0435\u0440 "+a.name+" \u043f\u0435\u0440\u0435\u0434\u0430\u043b \u0434\u0438\u0430\u043b\u043e\u0433 \u0432 "+g.name+" \u043c\u0435\u043d\u0435\u0434\u0436\u0435\u0440\u0443 "+b.name).then(function(q){var q=q.data,s=q.objs[0].entity;s.msg=d.prepareMsg(s.msg,1);q.objs[0].error||n.createCopyMsgs(e,g.id,b.id,r).then(function(d){var d=
d.data,t=d.infoToCopy.contactCopy;0==parseInt(d.error)?(c.send(JSON.stringify({event:"support-forward-account",prevManager:a,nextManager:b,prevAccountId:e,nextAccountId:g.id,prevContact:{id:k,type:p},nextContact:{id:t,type:"alone"},msg:s,copies:d.copies})),f.getContact(e,k,p).then(function(a){c.send(JSON.stringify({event:"inform-user-forward-account",receiverId:a.members[0],currentAccountId:e,nextAccount:g,contact:{id:k,type:p},nextContact:{id:t,type:"alone"}}))}),j.eClearSelectMsgs()):alert(d.info)})})}},
pushMsgInThread:function(a){d.isSP()&&(this.internalMsg=a,this.hasInternalMsg=!this.hasInternalMsg)},copiesMsgs:{},hasCopies:!1,addCopiesInThread:function(a,c){d.isSP()&&(this.copiesMsgs.msgs=c,this.copiesMsgs.contact=a,this.hasCopies=!this.hasCopies)},_send:function(c,b){return a.get("/profile/"+e.myId+"/"+c+"/",{params:b})},sendInternalMsg:function(a,c,b,e){return this._send("sendMsg",{accountId:a,receivers:angular.toJson([{id:c,type:b,isOnline:!0}]),msg:d.prepareMsg(e,0),attach:angular.toJson([]),
isinternal:1})},anchoredManagerContact:{},anchoredContact:!1,setAnchoredManagerContacts:function(a){"undefined"!=typeof a&&(this.anchoredManagerContact=a)},assignTalkManager:function(a,c,b){this.anchoredManagerContact[b.id+b.type+c]=a;this.anchoredContact=!this.anchoredContact},unassignTalkManager:function(a,c,b){"undefined"!=typeof this.anchoredManagerContact[b.id+b.type+c]&&delete this.anchoredManagerContact[b.id+b.type+c];this.anchoredContact=!this.anchoredContact},changeTalkManager:function(a,
c,b,d){this.anchoredManagerContact[d.id+d.type+b]=c;this.anchoredContact=!this.anchoredContact;this.selectManager(b,e.myId).then(function(a){parseInt(a.id);parseInt(c.id)})},changeTalkAccount:function(a,c,b,d,f,g){this.anchoredManagerContact[g.id+g.type+c]=d;delete this.anchoredManagerContact[f.id+f.type+a];this.anchoredContact=!this.anchoredContact;this.selectManager(accountId,e.myId).then(function(a){parseInt(a.id);parseInt(d.id)})},getCurrentManagerContact:function(a,c,b){return"undefined"!=typeof this.anchoredManagerContact[c+
b+a]?this.anchoredManagerContact[c+b+a]:{id:0,name:""}},selectManager:function(a,c){var d=b.defer();g.getAccountManagers(a).then(function(a){var b=null;angular.forEach(a,function(a){a.id==c&&(b=a)});b?d.resolve(b):d.reject()});return d.promise}}}]);chatApp.directive("addFindContact",["$compile","chatService",function(){return{restrict:"AE",link:function(a,b){b.bind("click",function(){var e=!0;0<a.searchService.selectContacts.length&&a.searchService.asyncSelected&&angular.forEach(a.searchService.selectContacts,function(c){c.id===a.searchService.asyncSelected.id&&(a.$broadcast("tooltipActive",{title:"\u042d\u0442\u043e\u0442 \u043a\u043e\u043d\u0442\u0430\u043a\u0442 \u0443\u0436\u0435 \u0434\u043e\u0431\u0430\u0432\u043b\u0435\u043d",targetEl:b,
hideInfo:!0}),e=!1)});if(e)if(a.searchService.asyncSelected)if("shop"==a.searchService.asyncSelected.type){var d={shopid:a.searchService.asyncSelected.id,shopname:a.searchService.asyncSelected.name};a.chatService.getContactByShop(a.activeAccount,a.searchService.asyncSelected.id).then(function(c){c=c.data;c.error||(d.shopContacts=c.shopContacts,a.searchService.selectContacts.push(d))})}else"alone"==a.searchService.asyncSelected.type?a.chatService.getContactByMembers(a.activeAccount,a.searchService.asyncSelected.id).then(function(c){c=
c.data;c.error||a.searchService.selectContacts.push(c)}):(a.searchService.selectContacts.push(a.searchService.asyncSelected),a.$broadcast("tooltipActive",{title:"K\u043e\u043d\u0442\u0430\u043a\u0442 \u0434\u043e\u0431\u0430\u0432\u043b\u0435\u043d",targetEl:b,hideInfo:!0}));else a.$broadcast("tooltipActive",{title:"\u0412\u044b \u043d\u0435 \u0432\u0432\u0435\u043b\u0438 \u0438\u043c\u044f \u043a\u043e\u043d\u0442\u0430\u043a\u0442\u0430!",targetEl:b,hideInfo:!0});a.searchService.asyncSelected=null;
a.$digest()})}}}]);
chatApp.directive("addFindContactMember",["$compile","chatService",function(){return{restrict:"AE",link:function(a,b){b.bind("click",function(){var e=!0;0<a.searchService.selectContacts.length&&a.searchService.asyncSelected&&angular.forEach(a.searchService.selectContacts,function(d){d.id===a.searchService.asyncSelected.id&&(a.$broadcast("tooltipActive",{title:"\u042d\u0442\u043e\u0442 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c \u0443\u0436\u0435 \u0434\u043e\u0431\u0430\u0432\u043b\u0435\u043d",targetEl:b,
hideInfo:!0}),e=!1)});e&&(a.searchService.asyncSelected?(a.searchService.selectContacts.push(a.searchService.asyncSelected),a.$broadcast("tooltipActive",{title:"\u041f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c \u0434\u043e\u0431\u0430\u0432\u043b\u0435\u043d",targetEl:b,hideInfo:!0})):a.$broadcast("tooltipActive",{title:"\u0412\u044b \u043d\u0435 \u0432\u0432\u0435\u043b\u0438 \u0438\u043c\u044f \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f!",targetEl:b,
hideInfo:!0}));a.searchService.asyncSelected=null;a.$digest()})}}}]);chatApp.directive("chatSearcher",["chatConfig","searchService",function(a,b){return{templateUrl:a.domenApp+"/lib/js/angular/apps/chat/partials/directive/chat-search.html",restrict:"E",scope:{searchType:"="},controller:["$scope",function(a){a.searchService=b;a.search=function(d){return b.getContacts(d,1,a.searchType)}}]}}]);
chatApp.directive("scrollPane",["chatService","$timeout",function(a,b){return{restrict:"A",link:function(e,d){var c=$(d),g;c.bind("jsp-scroll-y",function(b,d){"dialogs"==c.data("spos")&&(a.scrollPosListDialogs=d)});c.jScrollPane({autoReinitialise:!0});g=c.data("jsp");e.$on("refresh",function(){b(function(){0<parseInt(c.data("action"))&&g.scrollToY(1E5)},500)});e.$on("setPositionScroll",function(){var c=a.scrollPosListDialogs;b(function(){g.scrollToY(c)},500)})}}}]);
chatApp.directive("tooltip",["$timeout",function(a){return{restrict:"A",link:function(b){b.$on("tooltipActive",function(b,d){$(d.targetEl).tooltip({title:d.title,container:"body",template:'<div class="tooltip"  role="tooltip" ><div class="tooltip-arrow" style="border-top-color:#0077be !important;"></div><div class="tooltip-inner" style="background-color:#0077be !important;"></div></div>'}).tooltip("show");a(function(){$(d.targetEl).tooltip("destroy")},1500)});b.$on("tooltipShow",function(a,b){$(b.targetEl).tooltip({title:b.title,
container:"body",template:'<div class="tooltip echat-tooltip"   role="tooltip" ><div class="tooltip-arrow" ></div><div class="tooltip-arrow-inner" > </div><div class="tooltip-inner"></div></div>'}).tooltip("show")});b.$on("tooltipHide",function(a,b){$(b.targetEl).tooltip("hide")});b.$on("tooltipTop",function(a,b){$(b.targetEl).tooltip({title:b.title,container:"body",template:'<div class="tooltip"   role="tooltip" ><div class="tooltip-arrow" style="border-top-color:#0077be !important;"></div><div class="tooltip-inner" style="background-color:#0077be !important;max-width: 350px !important;"></div></div>'}).tooltip("show")})}}}]);
chatApp.directive("setfocus",["$interval","$timeout",function(a,b){return{restrict:"A",scope:{setfocus:"="},link:function(e,d){if(!0===e.setfocus){var c=$(d[0]),g=c.css("background-color");e.aTimer=a(function(){c.hasClass("add-border")?c.removeClass("add-border").css("backgroundColor",g):c.addClass("add-border").css("backgroundColor","#faa732")},500);b(function(){a.cancel(e.aTimer);c.removeClass("add-border").css("backgroundColor",g)},2E3)}}}}]);
chatApp.directive("chatSetting",["chatConfig",function(a){return{templateUrl:a.domenApp+"/lib/js/angular/apps/chat/partials/directive/chat-setting.html",restrict:"E",controller:["$scope",function(a){a.toolsManager.loadAllTools().then(function(e){a.chatTools=e})}]}}]);
chatApp.directive("showOnlineShop",["onlineShop","online","chatConfig",function(a,b,e){return{restrict:"A",link:function(d,c){d.onlineShop=a;d.online=b;d.info="";d.shopOnline=!1;d.managerOnline=0;var g=$(c),f=g.attr("data-shopid");d.$watch("online.countAllOnlines",function(a,c){a!=c&&void 0!=a&&d.onlineShop.getManagersShop(f).then(function(a){var c=!1;a.forEach(function(a){for(var b in d.online.allOnlineCommunity)parseInt(a.id)==parseInt(d.online.allOnlineCommunity[b])&&(c=!0,d.managerOnline=parseInt(a.id))});
c?(d.shopOnline=!0,g.find("#bk-question-online").show(),g.find("#bk-question-offline").hide(),d.info="(\u043e\u043d\u043b\u0430\u0439\u043d)"):(d.shopOnline=!1,g.find("#bk-question-online").hide(),g.find("#bk-question-offline").show())})});c.bind("click",function(){d.shopOnline&&d.managerOnline&&d.$broadcast("echatController.event.createContactShop",{clientId:e.myId,shopManagerId:d.managerOnline})})}}}]);
chatApp.directive("selectMsg",["msgsManager",function(a){return{scope:{smsg:"=smsg"},template:'<div class="selector-msg"  data-selected="0" ng-click="selectMsg($event)"><span style="display: block;cursor: pointer;">&#10004;</span></div>',restrict:"E",controller:["$scope",function(b){b.selectMsg=function(e){e=$(e.target);0<parseInt(e.attr("data-selected"))?(e.css("color","#ddd"),e.attr("data-selected",0)):(e.css("color","#faa732"),e.attr("data-selected",1));a.toggleSelectMsg(b.smsg)}}],link:function(a,
e){a.$on("clearSelectedMsgs",function(){$(e).find(".selector-msg>span").css("color","#ddd")})}}}]);chatApp.directive("dynamic",["$compile",function(a){return{restrict:"A",replace:!0,link:function(b,e,d){b.$watch(d.dynamic,function(c){e[0].innerHTML=c;a(e.contents())(b)})}}}]);
chatApp.directive("pickOut",function(){return{restrict:"A",link:function(a,b){$(b[0]).bind("mouseenter",function(){var a=$(b[0]);$(".modal_online").each(function(){var b={aw:"1001",cw:"1002",mw:"1003"};a.data("name")!=$(this).data("name")?$(this).css({zIndex:b[$(this).data("name")]}):$(this).css({zIndex:9999})})}).bind("mouseleave",function(){var a={aw:"9997",cw:"9998",mw:"9999"};$(".modal_online").each(function(){$(this).css({zIndex:a[$(this).data("name")]})})})}}});
chatApp.directive("blinkInformer",["msgsManager",function(a){return{restrict:"A",controller:["$scope","$interval",function(b,e){b.activeColor="";b.workelement=null;var d;b.msgsManager=a;b.working=function(a,d){b.workelement=a;0<parseInt(d)?b.start():b.stop()};b.blink=function(){"#29ABE2"==b.activeColor?(b.workelement.css("background-color","#faa732"),b.activeColor="#faa732"):(b.workelement.css("background-color","#29ABE2"),b.activeColor="#29ABE2")};b.start=function(){b.stop();d=e(b.blink,1E3)};b.stop=
function(){e.cancel(d);b.workelement.css("background-color","#29ABE2")}}],link:function(b,e){b.working(e,a.countNewMsg);b.$watch("msgsManager.countNewMsg",function(d,c){d!=c&&void 0!=d&&b.working(e,a.countNewMsg)})}}}]);chatApp.directive("ceResize",["$document",function(a){return function(b,e){function d(a){var b=c.left+c.width-50,a=a.pageX>b?b:a.pageX,b=c.left-a+c.width;f>b&&b>g&&e.css({left:a+"px",width:b+"px","font-size":14<3*(b/100)?3*(b/100)+"px":"14px"})}var c,g=250,f=1100,j=function(a){var b=c.top+c.height-50,a=a.pageY>b?b:a.pageY,b=c.top-a+c.height;800>b&&400<b&&e.css({top:a+"px",height:b+"px","font-size":14<3*(width/100)?3*(width/100)+"px":"14px"})},h=function(a){a=a.pageX>e[0].offsetLeft+50?a.pageX-e[0].offsetLeft:
50;f>a&&a>g&&e.css({width:a+"px","font-size":14<3*(a/100)?3*(a/100)+"px":"14px"})},m=function(a){a=a.pageY>e[0].offsetTop+50?a.pageY-e[0].offsetTop:50;800>a&&400<a&&e.css({height:a+"px","font-size":14<3*(width/100)?3*(width/100)+"px":"14px"})},l=function(b,d){newElement=angular.element('<div class="'+b+'"></div>');e.append(newElement);newElement.on("mousedown",function(b){function f(a){e.css({border:"solid 1px #C1E0FF"}).children().css({opacity:0});a.preventDefault();for(var b=0;b<d.length;b++)d[b](a)}
function g(){$(".body_modal_online").height(e.height());e.css({border:"none"}).children().animate({opacity:1},1E3);a.off("mousemove",f);a.off("mouseup",g)}a.on("mousemove",f);a.on("mouseup",g);c=b;c.top=e[0].offsetTop;c.left=e[0].offsetLeft;c.width=e[0].offsetWidth;c.height=e[0].offsetHeight})};l("sw-resize",[m,d]);l("ne-resize",[j,h]);l("nw-resize",[j,d]);l("se-resize",[m,h]);l("w-resize",[d]);l("e-resize",[h]);l("n-resize",[j]);l("s-resize",[m])}}]);
chatApp.directive("myDraggable",["$document",function(a){return{restrict:"A",replace:!1,link:function(b,e,d){function c(a){var b=f+a.clientX-h,c=j+a.clientY-m,d=window.innerWidth-e.prop("offsetWidth"),g=window.innerHeight-e.prop("offsetHeight");e.css({top:(c<g?0<c?c:0:g)+"px",left:(b<d?0<b?b:0:d)+"px"});a.preventDefault()}function g(){a.unbind("mousemove",c);a.unbind("mouseup",g)}var f,j,h,m;e.bind("mousedown",function(b){f=e.prop("offsetLeft");j=e.prop("offsetTop");h=b.clientX;m=b.clientY;a.bind("mousemove",
c);a.bind("mouseup",g);b.preventDefault()});0<parseInt(d.isparent)&&(e=e.parent())}}}]);chatApp.directive("supportControls",["chatConfig","accountsManager","support","msgsManager",function(a,b,e,d){return{templateUrl:a.domenApp+"/lib/js/angular/apps/chat/partials/directive/support-buttons.html",scope:{account:"@",contact:"@",lastmsg:"@",viewtype:"@"},restrict:"E",controller:["$scope",function(c){c.support=e;c.descSupportButton="";c.action={answer:1,notAnswer:2,forwardManager:3,forwardAccount:4,forwardShop:5,all:6};c.isShowActionFrame=!1;c.accountManagers=[];c.supportAccounts=[];c.isforwardM=
!1;c.isforwardA=!1;c.styler={};c.customization=function(){c.styler={positionPopup:null};switch(c.viewtype){case "1":c.styler.positionPopup={bottom:"86px",left:"10px"};break;case "2":c.styler.positionPopup={bottom:"86px",left:"10px"}}};c.customization();c.takeChat=function(){e.selectManager(c.account,a.myId).then(function(a){var b=angular.fromJson(c.contact);e.acceptChat(a,c.account,b.id,b.type)})};c.notTakeChat=function(){e.selectManager(c.account,a.myId).then(function(a){var b=angular.fromJson(c.contact),
d=e.getCurrentManagerContact(c.account,b.id,b.type);parseInt(d.id)==parseInt(a.id)&&e.notAcceptChat(a,c.account,b.id,b.type);c.blockedSupportControls()})};c.forwardManager=function(b){e.selectManager(c.account,a.myId).then(function(a){var d=angular.fromJson(c.contact),h=e.getCurrentManagerContact(c.account,d.id,d.type);parseInt(h.id)==parseInt(a.id)&&(e.forwardManager(h,b,c.account,d.id,d.type),c.isShowActionFrame=!c.isShowActionFrame)})};c.forwardAccount=function(b,f){e.selectManager(c.account,a.myId).then(function(a){var h=
angular.fromJson(c.contact),m=e.getCurrentManagerContact(c.account,h.id,h.type);if(parseInt(m.id)==parseInt(a.id)){a=[];a=d.eGetIdSelectMsgs();if(0==a.length){var l=angular.fromJson(c.lastmsg);a.push(l.id)}e.forwardAccount(m,f,c.account,b,h.id,h.type,a);c.isShowActionFrame=!c.isShowActionFrame}})};c.forwardShop=function(){e.selectManager(c.account,a.myId).then(function(b){var d=angular.fromJson(c.contact),j=e.getCurrentManagerContact(c.account,d.id,d.type);parseInt(j.id)==parseInt(b.id)&&(window.location.href=
a.domenApp+"/profile/"+a.myId+"/tatetChat/#/chat/forward/aid/"+c.account+"/cid/"+d.id+"/cty/"+d.type+"/ity/shop")})};c.informStateTalk="";c.$watch("support.anchoredContact",function(a,b){a!=b&&void 0!=a&&c.setStateSupportControls()});c.$watch("contact",function(a,b){a!=b&&void 0!=a&&c.setStateSupportControls()});c.visAnswer=c.visNotAnswer=c.visForwardManager=c.visForwardAccount=c.visForwardShop=c.visAll=!0;c.setStateSupportControls=function(){var b=angular.fromJson(c.contact);if("undefined"!=typeof b&&
0<Object.keys(b).length)if(b=e.getCurrentManagerContact(c.account,b.id,b.type),0<parseInt(b.id)){var d=parseInt(b.id)==parseInt(a.myId)?!0:!1;c.informStateTalk=0<parseInt(b.id)?"\u0421 \u043a\u043e\u043d\u0442\u0430\u043a\u0442\u043e\u043c \u0441\u0435\u0439\u0447\u0430\u0441 \u0440\u0430\u0431\u043e\u0442\u0430\u0435\u0442 \u043c\u0435\u043d\u0435\u0434\u0436\u0435\u0440 "+b.name:"";c.visAnswer=!1;c.visNotAnswer=c.visForwardManager=c.visForwardAccount=c.visForwardShop=c.visAll=d}else c.informStateTalk=
"",c.visAnswer=c.visNotAnswer=c.visForwardManager=c.visForwardAccount=c.visForwardShop=c.visAll=!0};c.blockedSupportControls=function(){};c.doSupportAction=function(a){switch(parseInt(a)){case c.action.answer:c.takeChat();break;case c.action.notAnswer:c.notTakeChat();break;case c.action.forwardManager:b.getAccountManagers(c.account).then(function(a){c.accountManagers=a;c.isShowActionFrame=!0;c.isforwardM=!0;c.isforwardA=!1});break;case c.action.forwardAccount:e.getSupports().then(function(a){c.supportAccounts=
a;c.isShowActionFrame=!0;c.isforwardM=!1;c.isforwardA=!0});break;case c.action.forwardShop:c.forwardShop()}};c.showInfo=function(a){c.$broadcast("tooltipTop",{title:"\u041c\u0435\u043d\u0435\u0434\u0436\u0435\u0440\u0443 \u043e\u0442\u043f\u0440\u0430\u0432\u0438\u0442\u0441\u044f \u043f\u043e\u0441\u043b\u0435\u0434\u043d\u0435\u0435 \u0441\u043e\u0431\u0449\u0435\u043d\u0438\u0435.\u0427\u0442\u043e\u0431 \u043f\u0435\u0440\u0435\u0434\u0430\u0442\u044c \u0431\u043e\u043b\u044c\u0448\u0435 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0439 \u0437\u0430\u043a\u0440\u043e\u0439\u0442\u0435 \u044d\u0442\u043e \u043e\u043a\u043d\u043e \u0438 \u0432\u0441\u043f\u0438\u0441\u043a\u0435 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0439 \u0432\u0438\u0434\u0435\u043b\u0438\u0442\u0435 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u044f \u043a\u043e\u0442\u043e\u0440\u044b\u0435 \u0445\u043e\u0442\u0438\u0442\u0435 \u043f\u0435\u0440\u0435\u0434\u0430\u0442\u044c",
targetEl:a.target})}}],link:function(a,b){$(b[0].querySelector(".chat-supports-panel .ul-action-support")).find("li").bind("mouseenter",function(b){b=b.target;switch(parseInt($(b).attr("data-btnnum"))){case 1:a.descSupportButton="\u041d\u0430\u0447\u0430\u0442\u044c \u0431\u0435\u0441\u0435\u0434\u0443";break;case 2:a.descSupportButton="\u041d\u0435 \u043e\u0442\u0432\u0435\u0447\u0430\u0442\u044c";break;case 3:a.descSupportButton="\u041f\u0435\u0440\u0435\u0434\u0430\u0442\u044c \u0434\u0440\u0443\u0433\u043e\u043c\u0443 \u043c\u0435\u043d\u0435\u0434\u0436\u0435\u0440\u0443";
break;case 4:a.descSupportButton="\u041f\u0435\u0440\u0435\u0434\u0430\u0442\u044c \u0434\u0440\u0443\u0433\u043e\u043c\u0443 \u0430\u043a\u043a\u0430\u0443\u043d\u0442\u0443";break;case 5:a.descSupportButton="\u041f\u0435\u0440\u0435\u0434\u0430\u0442\u044c \u043c\u0430\u0433\u0430\u0437\u0438\u043d\u0443"}$(b).animate({width:"30px",height:"30px",opacity:0.5},200);a.$apply()}).bind("mouseleave",function(a){$(a.target).animate({width:"32px",height:"32px",opacity:1},200)}).bind("click",function(b){a.doSupportAction($(b.target).attr("data-btnnum"))})}}}]);chatApp.controller("contactsController",["$scope","$route","$window","$routeParams","$location","$http","chatService","searchService","socketService","$timeout","chatConfig","accountsManager","contactsManager",function(a,b,e,d,c,g,f,j,h,m,l,o){a.$route=b;a.$routeParams=d;a.isSearchOwn=1;a.chatService=f;a.searchService=j;a.isglobalSearch=!1;a.titleApp="";a.emptyInfo="";a.domenApp=l.domenApp;e.document.title="\u0427\u0430\u0442. \u041c\u043e\u0438 \u041a\u043e\u043d\u0442\u0430\u043a\u0442\u044b";b=
{type:"all",actions:[{sno:1,name:{alone:"\u0423\u0434\u0430\u043b\u0438\u0442\u044c \u043a\u043e\u043d\u0442\u0430\u043a\u0442",group:"\u0423\u0434\u0430\u043b\u0438\u0442\u044c \u0433\u0440\u0443\u043f\u043f\u0443"},type:"delete"},{sno:1,name:{alone:"\u0411\u043b\u043e\u043a\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u043a\u043e\u043d\u0442\u0430\u043a\u0442",group:"\u0411\u043b\u043e\u043a\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u0433\u0440\u0443\u043f\u043f\u0443"},type:"block"},{sno:1,name:{alone:"\u041d\u0430\u043f\u0438\u0441\u0430\u0442\u044c \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0435",
group:"\u041d\u0430\u043f\u0438\u0441\u0430\u0442\u044c \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0435"},type:"writeMsg"}]};e={type:"own",actions:[{sno:1,name:{alone:"\u041e\u0442\u043c\u0435\u043d\u0438\u0442\u044c \u0437\u0430\u043f\u0440\u043e\u0441",group:"\u041e\u0442\u043c\u0435\u043d\u0438\u0442\u044c \u0437\u0430\u043f\u0440\u043e\u0441"},type:"cancel"}]};d={type:"other",actions:[{sno:1,name:{alone:"\u041e\u0442\u043c\u0435\u043d\u0438\u0442\u044c",group:"\u041e\u0442\u043c\u0435\u043d\u0438\u0442\u044c"},
type:"no_accepted"},{sno:1,name:{alone:"\u041f\u0440\u0438\u043d\u044f\u0442\u044c",group:"\u041f\u0440\u0438\u043d\u044f\u0442\u044c"},type:"accepted"}]};a.activeAccount=0;a.countContacts=!0;a.loadContacts=function(b){o.getAccount(a.activeAccount).getContacts(b.type).then(function(c){a.contacts=c;console.log(a.contacts);a.actions=b.actions;a.chatService.dataLoaded=!0;a.countContacts=0<a.contacts.length?!0:!1})};a.processContact=function(b,c){var d=null,e;for(e in a.contacts)if(a.contacts[e].id==
b){d=a.contacts[e];break}if(d)switch(c){case "delete":case "block":case "cancel":case "accepted":case "no_accepted":a.updateStatusContact(d.id,c,d.type);break;case "writeMsg":a.writeMsg(d.id,d.type)}};a.updateStatusContact=function(b,c,d){g.get("/profile/"+l.myId+"/updateStatusChatContact/",{params:{accountId:a.activeAccount,contactId:b,status:c,typeContact:d}}).success(function(){for(var c in a.contacts)if(a.contacts[c].id==b){a.contacts.splice(c,1);0==a.contacts.length&&(a.countContacts=!1);break}}).error(function(){})};
a.writeMsg=function(b,d){c.path("/chat/messages/create_msg/accountId/"+a.activeAccount+"/id/"+b+"/typeContact/"+d)};a.addToMyContacts=function(b){var c=b.target;g.get("/profile/"+l.myId+"/createAloneContact/",{params:{accountId:a.activeAccount,invitedId:a.searchService.asyncSelected.id}}).success(function(b){b.error||(b.isnew&&(a.contacts.unshift(b.model),0<a.contacts.length&&(a.countContacts=!0)),a.searchService.asyncSelected=null);a.$broadcast("tooltipActive",{title:b.msg,targetEl:c,hideInfo:!0})}).error(function(){})};
var k=null;if(!angular.isDefined(a.contacts)){if("undefined"!=typeof a.$routeParams.type)switch(a.$routeParams.type){case b.type:k=b;a.isglobalSearch=!0;a.titleApp="\u041c\u043e\u0438 \u041a\u043e\u043d\u0442\u0430\u043a\u0442\u044b";a.emptyInfo="\u0423 \u0432\u0430\u0441 \u043d\u0435\u0442 \u043a\u043e\u043d\u0442\u0430\u043a\u0442\u043e\u0432";break;case e.type:k=e;a.titleApp="\u041c\u043e\u0438 \u0417\u0430\u043f\u0440\u043e\u0441\u044b";a.emptyInfo="\u041d\u043e\u0432\u044b\u0445 \u0437\u0430\u043f\u0440\u043e\u0441\u043e\u0432 \u043d\u0435\u0442";
break;case d.type:k=d,a.titleApp="\u041c\u043e\u0438 \u0417\u0430\u044f\u0432\u043a\u0438",a.emptyInfo="\u041d\u043e\u0432\u044b\u0445 \u0437\u0430\u044f\u0432\u043e\u043a \u043d\u0435\u0442"}else k=b;o.loadAll().then(function(b){a.accounts=b;a.activeAccount=a.accounts[0].id;a.loadContacts(k)})}a.changeAccount=function(b){a.activeAccount=b;a.loadContacts(k)}}]);chatApp.controller("dialogsController",["$scope","$rootScope","$route","$window","$routeParams","$location","$http","$sce","chatService","chatConfig","accountsManager",function(a,b,e,d,c,g,f,j,h,m,l){a.$route=e;a.$location=g;a.$routeParams=c;a.chatService=h;a.countInfo="";a.domenApp=m.domenApp;a.activeAccount=0;d.document.title="\u0427\u0430\u0442. \u041c\u043e\u0438 \u0414\u0438\u0430\u043b\u043e\u0433\u0438";a.getTermination=function(a){var b=["\u0434\u0438\u0430\u043b\u043e\u0433","\u0434\u0438\u0430\u043b\u043e\u0433\u0430",
"\u0434\u0438\u0430\u043b\u043e\u0433\u043e\u0432"],c="",a=a%100;if(11<=a&&19>=a)c=b[2];else switch(i=a%10,i){case 1:c=b[0];break;case 2:case 3:case 4:c=b[1];break;default:c=b[2]}return a+" "+c};a.loadThreads=function(b){a.chatService.dataLoaded=!1;f.get("/profile/"+m.myId+"/getChatThreads/",{params:{accountId:b}}).success(function(b){angular.forEach(b,function(b){b.msg=a.chatService.transformTag(b.msg,a.chatService.codeToTagImg);b.msg=a.chatService.transformTag(b.msg,a.chatService.codeToTagA)});
a.threads=b;a.countInfo=a.getTermination(a.threads.length);a.countDialog=a.threads.length;a.chatService.dataLoaded=!0;a.$broadcast("setPositionScroll",{})})};a.showDetailDialog=function(b,c){g.path("/chat/messages/dialog/"+a.activeAccount+"/"+b+"/"+c)};a.createMsg=function(){g.path("/chat/messages/create_msg/accountId/"+a.activeAccount)};a.changeAccount=function(b){a.activeAccount=b;a.loadThreads(a.activeAccount)};b.$on("SharedEmitCM",function(b,c){a.changeAccount(c.accountId)});angular.isDefined(a.threads)||
l.loadAll().then(function(b){a.accounts=b;a.activeAccount="undefined"==typeof a.$routeParams.accountId?a.accounts[0].id:a.$routeParams.accountId;a.loadThreads(a.activeAccount)})}]);chatApp.controller("dialogController",["$scope","$rootScope","$route","$window","$routeParams","$location","$http","$sce","msgStorage","$timeout","msgsManager","chatService","socketService","chatConfig","contactsManager","accountsManager",function(a,b,e,d,c,g,f,j,h,m,l,o,k,p,r,n){a.$route=e;a.$location=g;a.$routeParams=c;a.chatService=o;a.msgsManager=l;a.statuses={"delete":"delete",spam:"spam"};a.lastAddMsg={};a.domenApp=p.domenApp;a.activeAccount=0;d.document.title="\u0427\u0430\u0442. \u041c\u043e\u0438 C\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u044f";
a.loadDialogMsgs=function(b,c,d,e){a.chatService.dataLoaded=!1;l.loadAll(b,c,d,e).then(function(b){a.thread=b.msgs;a.partnerInfo=b.personalInfoContact;a.chatService.dataLoaded=!0;a.$broadcast("refresh",{});0==p.isShop&&$("#editor").mbSmilesBox({coveringElement:".container_editor",prightBtn:160,ptopBtn:40})})};a.getPeriodMsgs=function(b){void 0==b&&(b="default");a.loadDialogMsgs(a.activeAccount,a.activeContact.id,a.activeContact.type,b)};a.sendMsg=function(){if("undefined"!=typeof a.$routeParams.contactId){var b=
[];b.push({id:a.activeContact.id,isOnline:!0,type:a.activeContact.type});var c=""+$("#editor").html();l.sendMsg(a.activeAccount,c,b).then(function(b){$("#editor").html("");a.thread.push(b.entity)});a.$broadcast("refresh",{})}};a.deleteAllSelect=function(){l.eClearSelectMsgs();a.$broadcast("clearSelectedMsgs",{})};a.forwardMessages=function(){var a=l.eGetSelectMsgs(),a=a.join("<br/>");h.setMsg(a);g.path("/chat/messages/create_msg/")};a.updateStatusMsgs=function(b){var c=l.eGetIdSelectMsgs();l.updateStatus(a.activeAccount,
b,c).then(function(b){b?alert("\u041f\u0440\u043e\u0438\u0437\u043e\u0448\u043b\u0430 \u043e\u0448\u0438\u0431\u043a\u0430, \u043f\u043e\u043f\u0440\u043e\u0431\u0443\u0439\u0442\u0435 \u043f\u043e\u0437\u0436\u0435."):(angular.forEach(c,function(b){angular.forEach(a.thread,function(c,d){c.id==b&&a.thread.splice(d,1)})}),l.eClearSelectMsgs(),a.$broadcast("clearSelectedMsgs",{}))})};a.setFocusEditor=function(){m(function(){l.eClearSelectMsgs();a.$broadcast("clearSelectedMsgs",{});$("#editor").focus()},
400)};a.showAllDialogs=function(){g.path("/chat/messages/dialogs/"+a.activeAccount)};b.$on("SharedEmitCM",function(b,c){if("undefined"!=typeof a.thread&&a.activeContact.id==c.contactId){var d=c.msg;d.own_msg=parseInt(d.sender_id)==a.activeAccount?1:0;a.thread.push(d);a.$broadcast("refresh",{})}});b.$on("SharedEmitIM",function(b,c){"undefined"!=typeof a.thread&&a.thread[0].contactId==c.contactId&&a.thread[0].type==c.type&&(a.thread.push(c),a.$broadcast("refresh",{}))});b.$on("SharedEmitRM",function(b,
c){"undefined"!=typeof a.thread&&parseInt(a.thread[0].contactId)==parseInt(c.contact.id)&&a.thread[0].type==c.contact.type&&(angular.forEach(c.msgs,function(b){a.thread.push(b)}),a.$broadcast("refresh",{}))});!angular.isDefined(a.thread)&&"undefined"!=typeof a.$routeParams.contactId&&(a.activeAccount=a.$routeParams.accountId,n.loadAll().then(function(){a.accountName=n.getAccount(a.activeAccount).name;r.getContact(a.activeAccount,c.contactId,a.$routeParams.type).then(function(b){a.activeContact=b;
a.loadDialogMsgs(a.activeAccount,a.activeContact.id,a.activeContact.type,"default")})}))}]);chatApp.controller("msgController",["$scope","$window","$routeParams","$http","msgStorage","chatService","searchService","socketService","contactsManager","msgsManager","chatConfig",function(a,b,e,d,c,g,f,j,h,m,l){a.$routeParams=e;a.chatService=g;a.socketService=j;a.searchService=f;a.domenApp=l.domenApp;a.contentEditor="";a.isCreateGroup=0;a.newNameGroup="";a.switchToGroup=!1;a.group=[];b.document.title="\u0427\u0430\u0442. \u041d\u0430\u043f\u0438\u0441\u0430\u0442\u044c \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u044f";
a.disabledCreateGroup=function(){var b=!1;0<a.searchService.selectContacts.length?angular.forEach(a.searchService.selectContacts,function(c){c.type==a.chatService.typeContact.Group&&(b=!0)}):(b=!0,a.isCreateGroup=!1);return b};a.createGroup=function(){if(a.isCreateGroup){var b=$("#group-img-load").attr("src"),c=[];angular.forEach(a.searchService.selectContacts,function(a){c.push({id:a.id})});c=angular.toJson(c);a.chatService.createGroup(this.newNameGroup,b,c,0).success(function(b){b.error||(a.group=
b.group,a.isCreateGroup=!1,a.switchToGroup=!0)})}};a.sendMsg=function(b){var c=b.target,d=[];a.switchToGroup?a.group&&d.push({id:a.group.groupId,isOnline:!1,type:a.chatService.typeContact.Group}):(console.log("$scope.searchService.selectContacts",a.searchService.selectContacts),angular.forEach(a.searchService.selectContacts,function(a){d.push({id:a.id,isOnline:!0,type:a.type})}));b=$("#editor").html();if(0<d.length){var e=0<parseInt(a.activeAccount)?a.activeAccount:l.myId;m.sendMsg(e,b,d).then(function(b){b.error||
$("#editor").html("");a.$broadcast("tooltipActive",{title:b.info_msg,targetEl:c,hideInfo:true})})}else a.$broadcast("tooltipActive",{title:"\u041d\u0443\u0436\u043d\u043e \u0434\u043e\u0431\u0430\u0432\u0438\u0442\u044c \u043f\u043e\u043b\u0443\u0447\u0430\u0442\u0435\u043b\u044f \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u044f.",targetEl:c,hideInfo:!0})};if("undefined"!=typeof a.$routeParams.id){a.activeAccount=a.$routeParams.accountId;var o="undefined"!=typeof a.$routeParams.typeContact?a.$routeParams.typeContact:
g.typeContact.Alone;a.searchService.selectContacts=[];h.getContact(a.activeAccount,a.$routeParams.id,o).then(function(b){"undefined"!=typeof b?a.searchService.selectContacts.push(b):a.chatService.getInfoContact(a.$routeParams.accountId,a.$routeParams.id,o).then(function(b){a.searchService.selectContacts.push(b.data)},function(){})})}"undefined"!=typeof a.$routeParams.invitedId&&(a.activeAccount=a.$routeParams.accountId,a.chatService.getContactByMembers(a.$routeParams.accountId,a.$routeParams.invitedId).then(function(b){b=
b.data;b.error||a.searchService.selectContacts.push(b)}));"undefined"!=typeof a.$routeParams.accountId&&(a.activeAccount=a.$routeParams.accountId);""!=c.getMsg()&&(a.contentEditor=c.getMsg());setTimeout(function(){l.isShop==0&&$("#editor").mbSmilesBox({coveringElement:".container_editor",prightBtn:160,ptopBtn:40})},200)}]);chatApp.controller("groupController",["$scope","$route","$window","$routeParams","$location","$http","chatService","searchService","chatConfig",function(a,b,e,d,c,g,f,j,h){a.$routeParams=d;a.chatService=f;a.searchService=j;a.domenApp=h.domenApp;a.activeAccount=0;a.extendThread=0;a.newNameGroup="";a.existsGroup=null;a.switchToGroup=!1;a.group=[];a.headTitle="";a.initExtend=function(b){f.getInfoChatContactMembers(b).then(function(b){angular.forEach(b.data,function(b){a.searchService.selectContacts.push(b)})},
function(){console.log("Error: initExtend")})};a.initAdd=function(b,c){parseInt(b)&&parseInt(c)&&f.getInfoContact(b,c,a.chatService.typeContact.Group).then(function(b){a.existsGroup=b.data},function(){console.log("Error: initAdd")})};a.disabledCreateGroup=function(){var b=!1;0<a.searchService.selectContacts.length?angular.forEach(a.searchService.selectContacts,function(c){c.type==a.chatService.typeContact.Group&&(b=!0)}):b=!0;return b};a.selectMembers=function(){var b=[];angular.forEach(a.searchService.selectContacts,
function(a){b.push({id:a.id})});return b};a.createGroup=function(b){var c=b.target,b=$("#group-img-load").attr("src"),d=a.selectMembers();d&&(d=angular.toJson(d),this.newNameGroup&&a.chatService.createGroup(a.activeAccount,this.newNameGroup,b,d,a.extendThread).success(function(b){b.error||(a.group=b.group,a.searchService.selectContacts=[],a.$broadcast("tooltipActive",{title:b.info,targetEl:c,hideInfo:!0}))}))};a.addInGroup=function(b,c){var d=b.target,e=a.selectMembers();e&&(e=angular.toJson(e),g.get("/profile/"+
h.myId+"/addMembersInGroup/",{params:{accountId:a.activeAccount,groupId:c,members:e}}).success(function(b){var c="";angular.forEach(b,function(a){c=parseInt(a.error)?c+("\u041e\u0448\u0438\u0431\u043a\u0430: "+a.msg):c+("\u0412\u044b\u043f\u043e\u043b\u043d\u0435\u043d\u043e: "+a.msg)});a.searchService.selectContacts=[];a.$broadcast("tooltipActive",{title:c,targetEl:d,hideInfo:!0})}).error(function(a,b){console.log(b)}))};if("undefined"!=typeof a.$routeParams.action&&"undefined"!=typeof a.$routeParams.params)switch(b=
a.$routeParams.action,d=JSON.parse(a.$routeParams.params),b){case "extend":e.document.title="\u0427\u0430\u0442. \u0420\u0430\u0441\u0448\u0438\u0440\u0435\u043d\u0438\u0435 \u0434\u0438\u0430\u043b\u043e\u0433\u0430 \u0434\u043e \u0433\u0440\u0443\u043f\u043f\u044b";a.headTitle="\u0420\u0430\u0441\u0448\u0438\u0440\u0435\u043d\u0438\u0435 \u0434\u0438\u0430\u043b\u043e\u0433\u0430 \u0434\u043e \u0433\u0440\u0443\u043f\u043f\u044b";a.activeAccount=d.accountId;a.extendThread=d.extendThread;a.searchService.selectContacts=
[];a.initExtend(d.idsExistsMembers);break;case "add":e.document.title="\u0427\u0430\u0442. \u0414\u043e\u0431\u0430\u0432\u0438\u0442\u044c \u0432 \u0433\u0440\u0443\u043f\u043f\u0443 \u0443\u0447\u0430\u0441\u0442\u043d\u0438\u043a\u043e\u0432",a.headTitle="\u0414\u043e\u0431\u0430\u0432\u0438\u0442\u044c \u0432 \u0433\u0440\u0443\u043f\u043f\u0443 \u0443\u0447\u0430\u0441\u0442\u043d\u0438\u043a\u043e\u0432",a.activeAccount=d.accountId,a.initAdd(a.activeAccount,d.groupId)}}]);chatApp.controller("forwardController",["$scope","$window","$routeParams","$http","msgStorage","chatService","searchService","socketService","contactsManager","msgsManager","chatConfig",function(a,b,e,d,c,g,f,j,h,m,l){a.$routeParams=e;a.chatService=g;a.socketService=j;a.searchService=f;a.domenApp=l.domenApp;a.contentEditor="";a.isCreateGroup=0;a.newNameGroup="";a.switchToGroup=!1;a.group=[];b.document.title="\u0427\u0430\u0442. \u041f\u0435\u0440\u0435\u0434\u0430\u0442\u044c \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0435";
a.sendMsg=function(b){var c=b.target,d=[];a.switchToGroup?a.group&&d.push({id:a.group.groupId,isOnline:!1,type:a.chatService.typeContact.Group}):(console.log("$scope.searchService.selectContacts",a.searchService.selectContacts),angular.forEach(a.searchService.selectContacts,function(a){d.push({id:a.id,isOnline:!0,type:a.type})}));b=$("#editor").html();if(0<d.length){var e=0<parseInt(a.activeAccount)?a.activeAccount:l.myId;m.sendMsg(e,b,d).then(function(b){b.error||$("#editor").html("");a.$broadcast("tooltipActive",
{title:b.info_msg,targetEl:c,hideInfo:true})})}else a.$broadcast("tooltipActive",{title:"\u041d\u0443\u0436\u043d\u043e \u0434\u043e\u0431\u0430\u0432\u0438\u0442\u044c \u043f\u043e\u043b\u0443\u0447\u0430\u0442\u0435\u043b\u044f \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u044f.",targetEl:c,hideInfo:!0})};"undefined"!=typeof a.$routeParams.aid&&"undefined"!=typeof a.$routeParams.cid&&"undefined"!=typeof a.$routeParams.cty&&"undefined"!=typeof a.$routeParams.ity&&(a.activeAccount=a.$routeParams.aid,
a.activeContact={id:a.$routeParams.cid,type:a.$routeParams.cty},a.searchService.selectContacts=[],h.getContact(a.activeAccount,a.activeContact.id,a.activeContact.type).then(function(b){"undefined"!=typeof b?a.activeContact.info=b:a.chatService.getInfoContact(a.activeAccount,a.activeContact.id,a.activeContact.type).then(function(b){a.activeContact.info=b.data},function(){})}));""!=c.getMsg()&&(a.contentEditor=c.getMsg());setTimeout(function(){l.isShop==0&&$("#editor").mbSmilesBox({coveringElement:".container_editor",
prightBtn:160,ptopBtn:40})},200)}]);chatApp.filter("filterIsOnline",function(){return function(a,b){var e={};if("undefined"!=a){if("!null"==b)return a;for(var d in a){var c=a[d];c.inOnline==b&&(e[d]=c)}return e}}});chatApp.filter("orderObjectBy",function(){return function(a,b,e){var d=[];angular.forEach(a,function(a){d.push(a)});d.sort(function(a,d){return a[b]>d[b]?1:-1});e&&d.reverse();return d}});
chatApp.filter("textSearchFilter",[function(){return function(a,b){if(b){var b=b.toLowerCase(),e=[];angular.forEach(a,function(a){0<=a.name.toLowerCase().indexOf(b)&&e.push(a)});return e}return a}}]);
chatApp.controller("echatController",["$scope","$rootScope","$sce","$filter","$interval","$window","$http","$timeout","accountsManager","contactsManager","msgsManager","online","audio","toolsManager","$notification","chatConfig","chatService","support","$location",function(a,b,e,d,c,g,f,j,h,m,l,o,k,p,r,n,q,s){a.chatService=q;a.chatConfig=n;a.online=o;a.msgsManager=l;a.support=s;a.activeAccount=0;a.activeAccountInfo={};a.activeContact={};a.visibleAccounts=!1;a.visibleContacts=!1;a.visibleMsgs=!1;a.showAddInGroup=
!1;a.newShops={};a.toolsManager=p;a.audio=k;a.toolsShow=!1;a.toolsManager.loadAllTools();a.showNewMsgInfo=function(b,c){b.preventDefault();var d=/&(nbsp|amp|quot|lt|gt);/g,e={nbsp:" ",amp:"&",quot:'"',lt:"<",gt:">"},f="",g="";angular.forEach(c.msg,function(a){g=g.replace(d,function(a,b){return e[b]});a=75<a.length?a.substring(0,70)+"...":a;f+='<div class="i-msg">'+a+"</div>"});var j='<div style="width: 250px;"><table class="i-header-table"><tr><td>\u043e\u0442</td><td>'+c.name+"</td></tr><tr><td>\u043a\u043e\u043c\u0443</td><td>"+
h.getAccount(c.accountId).name+'</td></tr></table><div class="i-body">'+f+'</div><div class="i-footer">\u041d\u043e\u0432\u044b\u0445 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0439: '+c.count_msgs+"</div></div>";a.$broadcast("tooltipShow",{title:j,targetEl:b.target})};a.closeNewMsgBlock=function(b,c){f.get("/profile/"+n.myId+"/setAnswered/",{params:{accountId:c.accountId,contactId:c.contactId,contactType:c.contactType}}).then(function(b){!b.error&&0<Object.keys(a.msgsManager.stackNewMsgs).length&&
(b=c.contactType+c.contactId,"undefined"!=typeof a.msgsManager.stackNewMsgs[b]&&(a.msgsManager.countNewMsg-=parseInt(a.msgsManager.stackNewMsgs[b].count_msgs),delete a.msgsManager.stackNewMsgs[b]))})};h.loadAll().then(function(b){a.accounts=b;l.loadNewMsgs();a.online.init();a.init()});a.init=function(){/^blog\./.test(location.hostname)?$("#echat-visible").css("display","none"):$("#echat-visible").css("display","block")};a.showAccounts=function(){a.visibleAccounts=!0};a.showContacts=function(b){a.activeAccount=
b;var c=h.getAccount(b);a.activeAccountInfo={id:c.id,name:c.name,logo:c.logo};c.getContacts("all").then(function(c){a.contacts=c;m.setOnlineStatus(b,a.online.onlineUsers);q.isSP()&&m.findNewShops(a.activeAccount,a.online.allOnlineCommunity).then(function(b){b=b.data.list;0<Object.keys(b).length?(a.newShops=b,a.existsNewShops=!0):a.existsNewShops=!1});a.visibleContacts=!0})};a.writeNewShopMsg=function(b){location.href="/profile/"+n.myId+"/tatetChat/#/chat/messages/create_msg/accountId/"+a.activeAccount+
"/invitedId/"+b};a.showWindowContacts=function(){h.isMultiAccounts()?a.showAccounts():a.showContacts(a.accounts[0].id)};a.showDialog=function(b,c){a.activeContact={id:b.id,type:b.type};a.chatService.dataLoaded=!1;"undefined"==typeof c&&(c="default");b.getMsgs(c).then(function(c){a.thread=c.msgs;a.openContact=b;a.partnerInfo=c.personalInfoContact;a.showAddInGroup=b.type==a.chatService.typeContact.Group&&b.admin_id==a.activeAccount?!0:!1;0==n.isShop&&$("#e_editor").mbSmilesBox({coveringElement:".write_modal"});
a.visibleMsgs=!0;a.chatService.dataLoaded=!0;a.$broadcast("refresh",{})})};a.goToDialog=function(b){m.getContact(a.activeAccount,b,"alone").then(function(b){a.showDialog(b,"default")})};a.showHistoryMsgs=function(b){a.showDialog(a.openContact,b);a.visibleDatePeriods=!a.visibleDatePeriods};a.showGroupMembers=function(a,b){a.stopPropagation();b.loadGroupMembers()};a.sendMsg=function(b){13===b.which&&!b.shiftKey?h.getAccount(a.activeAccount).getContact(a.activeContact.id,a.activeContact.type).then(function(b){b.inOnline=
o.getOnlineUsers(b.members).length?!0:!1;var b=[{id:b.id,type:b.type,isOnline:b.inOnline}],c=$("#e_editor").html(),c=c.replace(/<br>/g,"\r\n");l.sendMsg(a.activeAccount,c,b).then(function(b){b.error?$("#e_editor").html('<p style="color:red;">'+b.info_msg+"</p>"):($("#e_editor").html(""),a.thread.push(b.entity),a.$broadcast("refresh",{}))})}):13==b.which&&b.shiftKey&&$(b.target).focusEnd()};a.informTypedMsg=function(b,c){l.informTypedMsg(a.partnerInfo,c)};a.inOnline="!null";a.titleToggleFilter="";
a.toggleFilterOnline=function(){a.toolsShow=!1;"!null"==a.inOnline?(a.inOnline=!0,a.titleToggleFilter="\u041a\u043e\u043d\u0442\u0430\u043a\u0442\u044b (\u0412\u0441\u0435 "+o.countOnlineUsers+")"):(a.inOnline="!null",a.titleToggleFilter="")};a.setViewedThread=function(b,c){"undefined"==typeof b&&(b=0,c="");l.setViewed(b,c).then(function(b){a.thread=b.msgs;a.activeAccount=b.viewInfo.accountId;var c=h.getAccount(a.activeAccount);a.activeAccountInfo={id:c.id,name:c.name,logo:c.logo};a.activeContact=
{id:b.viewInfo.contactId,type:b.viewInfo.contactType};a.openContact={id:b.viewInfo.contactId,type:b.viewInfo.contactType};a.partnerInfo=b.personalInfoContact;a.visibleMsgs=true;a.chatService.dataLoaded=true;a.$broadcast("refresh",{})})};a.delInfoWritingMsg=function(b){angular.forEach(a.thread,function(c,d){"fake"===c.type&&(a.thread.splice(d,1),b&&a.$broadcast("refresh",{}))})};a.$watch("msgsManager.notifyMsg",function(b,c){b!=c&&void 0!=b&&(a.toolsManager.getTool(a.toolsManager.audioNotify).getState()&&
a.audio.play(),a.createNotification())});a.$watch("msgsManager.waitingMsg",function(b,c){b!=c&&void 0!=b&&"undefined"!=typeof a.thread&&(a.msgsManager.iswritingNow?(a.thread.push({wait_msg:!0,id:0,type:"fake"}),a.$broadcast("refresh",{})):a.delInfoWritingMsg(!0))});a.$watch("msgsManager.countNewMsg",function(a,b){a!=b&&void 0!=a&&$("li a[href$='#/chat/messages/dialogs']").html('\u0421\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u044f <span style="font-weight: 600;">('+l.countNewMsg+")</span>")});a.$watch("support.hasInternalMsg",
function(c,d){c!=d&&void 0!=c&&("undefined"!=typeof a.thread&&a.thread[0].contactId==a.support.internalMsg.contactId&&a.thread[0].type==a.support.internalMsg.type&&(a.thread.push(a.support.internalMsg),a.$broadcast("refresh",{})),b.$emit("SharedEmitIM",a.support.internalMsg))});a.$watch("support.hasCopies",function(c,d){c!=d&&void 0!=c&&("undefined"!=typeof a.thread&&parseInt(a.thread[0].contactId)==parseInt(a.support.copiesMsgs.contact.id)&&a.thread[0].type==a.support.copiesMsgs.contact.type&&(angular.forEach(a.support.copiesMsgs.msgs,
function(b){a.thread.push(b)}),a.$broadcast("refresh",{})),b.$emit("SharedEmitRM",a.support.copiesMsgs))});a.$on("echatController.event.createContactShop",function(b,c){var d=Math.min(c.clientId,c.shopManagerId)*Math.pow(10,9)+Math.max(c.clientId,c.shopManagerId);a.activeAccount=a.accounts[0].id;h.getAccount(a.activeAccount).getContact(d,"alone").then(function(b){a.showDialog(b,"default")})});a.createNotification=function(){var c=l.stackNotifyMsg.pop(),d=c.msg;"undefined"!=typeof a.thread&&a.openContact.id==
c.contactId&&(d.own_msg=parseInt(d.sender_id)==a.activeAccount?1:0,a.delInfoWritingMsg(!0),a.thread.push(d),a.$broadcast("refresh",{}));b.$emit("SharedEmitCM",c);c.msg=d.msg;l.addAmountNewMsgs(c.accountId,c);a.toolsManager.getTool(a.toolsManager.notifyPanel).getState()&&!c.childChat&&(d="undefined"!=typeof h.getAccount(c.accountId)?h.getAccount(c.accountId).name:"",c=r("\u041d\u043e\u0432\u043e\u0435 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0435 "+d,{body:"\u043e\u0442 "+c.name,delay:7E3,
icon:c.logo}),c.$on("show",function(){}),c.$on("close",function(){}),c.$on("error",function(){}))};a.transferDialog=function(){var b=JSON.stringify({accountId:a.activeAccount,extendThread:a.activeContact.id,idsExistsMembers:[a.partnerInfo.id,a.activeAccount]});window.location=n.domenApp+"/profile/"+n.myId+"/tatetChat/#/chat/messages/group/action/extend/params/"+b};a.toMaximizeChat=function(){window.location=n.domenApp+"/profile/"+n.myId+"/tatetChat/#/chat/messages/dialog/"+a.activeAccount+"/"+a.activeContact.id+
"/"+a.activeContact.type};a.addInGroup=function(){if(a.thread[0].type==a.chatService.typeContact.Group){a.visibleMsgs=!1;a.visibleContacs=!1;var b=JSON.stringify({accountId:a.activeAccount,groupId:a.activeContact.id});window.location=n.domenApp+"/profile/"+n.myId+"/tatetChat/#/chat/messages/group/action/add/params/"+b}}}]);
